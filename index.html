<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Waldo's Tactical Trainer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #1e1e1e; color: #fff; height: 100vh; height: 100dvh; overflow: hidden; display: flex; touch-action: none; }
        
        .sidebar { width: 170px; background: #2d2d2d; padding: 10px; display: flex; flex-direction: column; gap: 10px; border-right: 1px solid #444; overflow-y: auto; overflow-x: hidden; z-index: 100; flex-shrink: 0; }
        .sidebar h1 { font-size: 12px; color: #4CAF50; margin-bottom: 4px; text-align: center; font-weight: 600; }
        .tool-section { background: #252525; border-radius: 8px; padding: 10px; border: 1px solid #444; }
        .tool-section h3 { font-size: 9px; color: #4CAF50; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .tool-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
        .tool-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
        .tool-btn { padding: 8px 4px; border: 1px solid #444; border-radius: 6px; background: #333; color: #fff; cursor: pointer; font-size: 16px; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; gap: 3px; min-height: 46px; }
        .tool-btn span { font-size: 8px; opacity: 0.7; }
        .tool-btn:hover { background: #444; border-color: #4CAF50; }
        .tool-btn.active { background: #4CAF50; border-color: #4CAF50; }
        
        .color-row { display: flex; gap: 6px; justify-content: center; margin-top: 8px; }
        .color-swatch { width: 30px; height: 30px; border-radius: 6px; cursor: pointer; border: 2px solid #444; transition: all 0.15s; }
        .color-swatch:hover, .color-swatch.active { border-color: #fff; transform: scale(1.1); }
        
        .slider-row { display: flex; align-items: center; gap: 4px; margin-top: 8px; }
        .slider-row label { font-size: 9px; color: #aaa; width: 28px; flex-shrink: 0; }
        .slider-row input[type="range"] { flex: 1; min-width: 0; height: 4px; -webkit-appearance: none; background: #444; border-radius: 2px; }
        .slider-row input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: #4CAF50; cursor: grab; }
        .slider-row .val { font-size: 9px; color: #aaa; width: 22px; text-align: right; flex-shrink: 0; }
        
        .main { flex: 1; position: relative; overflow: hidden; background: #1a1a1a; }
        .toolbar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(45, 45, 45, 0.95); padding: 6px 10px; border-radius: 8px; display: flex; gap: 6px; align-items: center; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid #444; }
        .toolbar button { padding: 6px 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: #fff; cursor: pointer; font-size: 11px; transition: all 0.15s; }
        .toolbar button:hover { background: #444; border-color: #4CAF50; }
        .toolbar button.active { background: #4CAF50; }
        .toolbar button.play-btn { background: #4CAF50; border-color: #43A047; font-weight: 600; }
        .toolbar button.play-btn:hover { background: #43A047; }
        .toolbar button.play-btn.playing { background: #FF9800; border-color: #F57C00; }
        .toolbar .divider { width: 1px; height: 20px; background: #444; }
        .toolbar select { padding: 6px; border-radius: 5px; border: 1px solid #444; background: #333; color: #fff; font-size: 11px; }
        
        #canvas { position: absolute; top: 0; left: 0; cursor: crosshair; touch-action: none; }
        .cursor-grab { cursor: grab !important; }
        .cursor-grabbing { cursor: grabbing !important; }
        .cursor-move { cursor: move !important; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: #2d2d2d; padding: 20px; border-radius: 10px; width: 380px; max-width: 90%; border: 1px solid #444; }
        .modal-content h2 { margin-bottom: 12px; color: #4CAF50; font-size: 15px; }
        .modal-content textarea { width: 100%; height: 180px; background: #1e1e1e; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 10px; }
        .modal-content .btn-row { display: flex; gap: 10px; margin-top: 12px; }
        .modal-content button { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; }
        .modal-content .btn-primary { background: #4CAF50; color: #fff; }
        .modal-content .btn-secondary { background: #444; color: #fff; }
        
        .sidebar-toggle { display: none; position: absolute; top: 60px; left: 10px; z-index: 110; width: 40px; height: 40px; border-radius: 8px; background: #2d2d2d; border: 1px solid #444; color: #fff; font-size: 18px; cursor: pointer; align-items: center; justify-content: center; }
        
        .context-menu { position: absolute; background: #2d2d2d; border: 1px solid #444; border-radius: 8px; padding: 8px; z-index: 200; box-shadow: 0 4px 20px rgba(0,0,0,0.4); min-width: 140px; display: none; }
        .context-menu.active { display: block; }
        .context-menu h4 { font-size: 10px; color: #4CAF50; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .context-menu button { display: block; width: 100%; padding: 8px 10px; margin-bottom: 4px; border: 1px solid #444; border-radius: 5px; background: #333; color: #fff; cursor: pointer; font-size: 11px; text-align: left; transition: all 0.15s; }
        .context-menu button:last-child { margin-bottom: 0; }
        .context-menu button:hover { background: #444; border-color: #4CAF50; }
        .context-menu .rotate-row { display: flex; gap: 4px; margin-bottom: 4px; }
        .context-menu .rotate-row button { flex: 1; text-align: center; padding: 8px 4px; }
        
        @media (max-width: 768px) {
            .sidebar { position: absolute; left: -180px; top: 0; height: 100%; transition: left 0.3s ease; box-shadow: 2px 0 20px rgba(0,0,0,0.5); }
            .sidebar.open { left: 0; }
            .sidebar-toggle { display: flex; }
            .toolbar { left: 55px; transform: none; max-width: calc(100% - 70px); flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>üéØ Waldo's Tactical Trainer</h1>
        <div class="tool-section">
            <h3>Tools</h3>
            <div class="tool-grid">
                <button class="tool-btn active" data-tool="select"><span style="font-size:18px">‚Üñ</span><span>Select</span></button>
                <button class="tool-btn" data-tool="pan"><span style="font-size:18px">‚úã</span><span>Pan</span></button>
                <button class="tool-btn" data-tool="pen"><span style="font-size:18px">‚úè</span><span>Marker</span></button>
                <button class="tool-btn" data-tool="erase"><span style="font-size:18px">‚úï</span><span>Erase</span></button>
            </div>
            <div class="color-row" id="drawColors">
                <div class="color-swatch active" style="background:#ff3333" data-color="#ff3333"></div>
                <div class="color-swatch" style="background:#222" data-color="#222222"></div>
                <div class="color-swatch" style="background:#3366ff" data-color="#3366ff"></div>
            </div>
        </div>
        <div class="tool-section">
            <h3>Structure</h3>
            <div class="tool-grid cols-3">
                <button class="tool-btn" data-tool="wall"><span style="font-size:16px">‚ñ¨</span><span>Wall</span></button>
                <button class="tool-btn" data-tool="door-closed"><span style="font-size:14px">‚ñØ</span><span>Door</span></button>
                <button class="tool-btn" data-tool="door-open"><span style="font-size:16px">‚äè</span><span>Open</span></button>
            </div>
        </div>
        <div class="tool-section">
            <h3>Characters</h3>
            <div class="tool-grid cols-3">
                <button class="tool-btn" data-tool="operator"><span style="font-size:18px;font-weight:bold">O</span><span>Operator</span></button>
                <button class="tool-btn" data-tool="threat"><span style="font-size:18px;font-weight:bold;color:#e94560">X</span><span>Threat</span></button>
                <button class="tool-btn" data-tool="civilian"><span style="font-size:18px;font-weight:bold;color:#4fc3f7">C</span><span>Civilian</span></button>
            </div>
            <div class="color-row" id="operatorColors">
                <div class="color-swatch active" style="background:#4CAF50" data-color="#4CAF50"></div>
                <div class="color-swatch" style="background:#2196F3" data-color="#2196F3"></div>
                <div class="color-swatch" style="background:#FF9800" data-color="#FF9800"></div>
                <div class="color-swatch" style="background:#9C27B0" data-color="#9C27B0"></div>
            </div>
            <div class="slider-row">
                <label>FOV</label>
                <input type="range" id="fovAngle" min="30" max="180" value="90">
                <span class="val" id="fovAngleVal">90</span>
            </div>
        </div>
        <div class="tool-section">
            <h3>Movement</h3>
            <div class="tool-grid">
                <button class="tool-btn" data-tool="path"><span style="font-size:18px">‚§¥</span><span>Path</span></button>
                <button class="tool-btn" id="clearPathBtn"><span style="font-size:18px">‚å´</span><span>Clear</span></button>
            </div>
        </div>
    </div>
    <div class="main">
        <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
        <canvas id="canvas"></canvas>
        <div class="toolbar">
            <button id="playBtn" class="play-btn">‚ñ∂ Play</button>
            <button id="rewindBtn">‚èÆ</button>
            <select id="speedSelect"><option value="0.5">0.5x</option><option value="1" selected>1x</option><option value="2">2x</option></select>
            <div class="divider"></div>
            <button id="undoBtn">‚Ü©</button>
            <button id="redoBtn">‚Ü™</button>
            <div class="divider"></div>
            <button id="gridToggle" class="active">Grid</button>
            <button id="fovToggle" class="active">FOV</button>
            <div class="divider"></div>
            <button id="newBtn">New</button>
            <button id="saveBtn">Save</button>
            <button id="loadBtn">Load</button>
            <select id="scenarioSelect"><option value="">Scenarios</option><option value="kpd-shoothouse">KPD Shoothouse</option><option value="small-house">Small House</option><option value="l-corridor">L-Corridor</option><option value="apartment">Apartment</option><option value="warehouse">Warehouse</option></select>
            <div class="divider"></div>
            <button id="submitBtn" style="background:#4CAF50;">üì§ Submit</button>
        </div>
    </div>
    <div class="modal" id="submitModal">
        <div class="modal-content">
            <h2>Submit Your Solution</h2>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#ccc;">Your Name:</label>
                <input type="text" id="submitterName" style="width:100%;padding:8px;border-radius:4px;border:1px solid #444;background:#2a2a2a;color:#fff;" placeholder="Enter your name">
            </div>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#ccc;">Scenario Name:</label>
                <input type="text" id="scenarioName" style="width:100%;padding:8px;border-radius:4px;border:1px solid #444;background:#2a2a2a;color:#fff;" placeholder="e.g., Room Clear Drill 1">
            </div>
            <div class="btn-row">
                <button class="btn-secondary" id="submitCancel">Cancel</button>
                <button class="btn-primary" id="submitConfirm" style="background:#4CAF50;">Submit</button>
            </div>
            <p id="submitStatus" style="margin-top:10px;text-align:center;color:#888;"></p>
        </div>
    </div>
    <div class="modal" id="configModal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Instructor Settings</h2>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#ccc;">Google Apps Script URL:</label>
                <input type="text" id="scriptUrl" style="width:100%;padding:8px;border-radius:4px;border:1px solid #444;background:#2a2a2a;color:#fff;" placeholder="https://script.google.com/macros/s/...">
            </div>
            <p style="color:#888;font-size:12px;">This URL is saved in your browser. Team members need it configured to submit.</p>
            <div class="btn-row">
                <button class="btn-secondary" id="configCancel">Cancel</button>
                <button class="btn-primary" id="configSave">Save</button>
            </div>
        </div>
    </div>
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Save</h2>
            <textarea id="modalData"></textarea>
            <div class="btn-row">
                <button class="btn-secondary" id="modalCancel">Cancel</button>
                <button class="btn-primary" id="modalConfirm">OK</button>
            </div>
        </div>
    </div>
    <div class="context-menu" id="contextMenu">
        <h4>Operator Menu</h4>
        <div class="rotate-row">
            <button id="rotateLeft" title="Rotate Left">‚Ü∫ Left</button>
            <button id="rotateRight" title="Rotate Right">Right ‚Üª</button>
        </div>
        <button id="addLookPoint">+ Add Look Point</button>
        <button id="clearPath">Clear Path</button>
        <div id="doorActions" style="display:none;">
            <div style="height:1px;background:#444;margin:8px 0;"></div>
            <h4 style="margin-bottom:6px;">Door Actions</h4>
            <button id="openDoor">üö™ Open Door</button>
            <button id="vtaOnly">üëÅ VTA</button>
            <button id="openDoorVTA">üö™ Open + VTA</button>
            <button id="closeDoor">üö™ Close Door</button>
        </div>
        <button id="deleteEntity">Delete</button>
    </div>
    <div class="context-menu" id="doorContextMenu">
        <h4>Door Settings</h4>
        <button id="swingInLeft">Swing In-Left</button>
        <button id="swingInRight">Swing In-Right</button>
        <button id="swingOutLeft">Swing Out-Left</button>
        <button id="swingOutRight">Swing Out-Right</button>
        <div style="height:1px;background:#444;margin:8px 0;"></div>
        <button id="toggleDoorState">Toggle Open/Closed</button>
        <button id="deleteDoor">Delete Door</button>
    </div>
<script>
const S={tool:'select',drawColor:'#ff3333',opColor:'#4CAF50',strokeSize:4,showGrid:true,showFOV:true,gridSize:30,fovAngle:90,fovRange:150,zoom:1,panX:0,panY:0,entities:[],drawings:[],history:[],historyIdx:-1,selected:null,drawing:false,erasing:false,panning:false,drawStart:null,path:[],dragOff:null,spaceHeld:false,playing:false,playTime:0,playSpeed:1,animFrame:null,pathBlocked:false,addingLookPoint:false,contextMenuOpen:false,doorAnims:{},queuedDoorActions:{}};
const E={WALL:'wall',DOOR_C:'door-closed',DOOR_O:'door-open',OP:'operator',THREAT:'threat',CIV:'civilian'};
const SCENARIOS={'kpd-shoothouse':{"name":"KPD Shoothouse","entities":[{"id":1765395625128,"type":"wall","x1":900,"y1":660,"x2":750,"y2":660,"swing":"in-left"},{"id":1765395654943.0044,"type":"wall","x1":1170,"y1":870,"x2":1170,"y2":210,"swing":"in-left"},{"id":1765395659087,"type":"wall","x1":390,"y1":210,"x2":390,"y2":60,"swing":"in-left"},{"id":1765395661336,"type":"wall","x1":1170,"y1":210,"x2":1170,"y2":60,"swing":"in-left"},{"id":1765395663137,"type":"wall","x1":1170,"y1":60,"x2":390,"y2":60,"swing":"in-left"},{"id":1765395745672.83,"type":"wall","x1":900,"y1":720,"x2":900,"y2":660,"swing":"in-left"},{"id":1765395751525.8616,"type":"wall","x1":1080,"y1":870,"x2":1170,"y2":870,"swing":"in-left"},{"id":1765395758069.2764,"type":"wall","x1":900,"y1":870,"x2":1020,"y2":870,"swing":"in-left"},{"id":1765395758069.1296,"type":"wall","x1":900,"y1":840,"x2":900,"y2":780,"swing":"in-left"},{"id":1765395762460,"type":"wall","x1":900,"y1":840,"x2":900,"y2":870,"swing":"in-left"},{"id":1765395773319.6294,"type":"wall","x1":750,"y1":870,"x2":810,"y2":870,"swing":"in-left"},{"id":1765395779652,"type":"door-closed","x1":810,"y1":870,"x2":900,"y2":870,"swing":"in-left"},{"id":1765395790839,"type":"door-closed","x1":630,"y1":870,"x2":750,"y2":870,"swing":"in-left"},{"id":1765395794780,"type":"door-closed","x1":1020,"y1":870,"x2":1080,"y2":870,"swing":"in-left"},{"id":1765395800138.1614,"type":"wall","x1":450,"y1":870,"x2":630,"y2":870,"swing":"in-left"},{"id":1765395804225,"type":"wall","x1":390,"y1":840,"x2":390,"y2":870,"swing":"in-left"},{"id":1765395808731,"type":"door-closed","x1":450,"y1":870,"x2":390,"y2":870,"swing":"in-left"},{"id":1765395814014,"type":"door-closed","x1":900,"y1":720,"x2":900,"y2":780,"swing":"in-left"},{"id":1765395823460.1592,"type":"wall","x1":900,"y1":660,"x2":1020,"y2":660,"swing":"in-left"},{"id":1765395823626.9775,"type":"wall","x1":1080,"y1":660,"x2":1170,"y2":660,"swing":"in-left"},{"id":1765395827522,"type":"door-closed","x1":1020,"y1":660,"x2":1080,"y2":660,"swing":"in-left"},{"id":1765395832145.356,"type":"wall","x1":1110,"y1":510,"x2":1170,"y2":510,"swing":"in-left"},{"id":1765395836789,"type":"door-closed","x1":1050,"y1":510,"x2":1110,"y2":510,"swing":"in-left"},{"id":1765395839909.1367,"type":"wall","x1":750,"y1":510,"x2":810,"y2":510,"swing":"in-left"},{"id":1765395840228.2656,"type":"wall","x1":870,"y1":510,"x2":1050,"y2":510,"swing":"in-left"},{"id":1765395848309,"type":"door-closed","x1":810,"y1":510,"x2":870,"y2":510,"swing":"in-left"},{"id":1765395852007.334,"type":"wall","x1":750,"y1":660,"x2":750,"y2":630,"swing":"in-left"},{"id":1765395852059.5413,"type":"wall","x1":750,"y1":570,"x2":750,"y2":360,"swing":"in-left"},{"id":1765395856152,"type":"door-closed","x1":750,"y1":570,"x2":750,"y2":630,"swing":"in-left"},{"id":1765395862694,"type":"wall","x1":990,"y1":510,"x2":990,"y2":420,"swing":"in-left"},{"id":1765395865944,"type":"door-closed","x1":990,"y1":420,"x2":990,"y2":360,"swing":"in-left"},{"id":1765395869282.3562,"type":"wall","x1":750,"y1":360,"x2":1050,"y2":360,"swing":"in-left"},{"id":1765395869558.6436,"type":"wall","x1":1110,"y1":360,"x2":1170,"y2":360,"swing":"in-left"},{"id":1765395872659,"type":"door-closed","x1":1050,"y1":360,"x2":1110,"y2":360,"swing":"in-left"},{"id":1765395877666.9873,"type":"wall","x1":750,"y1":240,"x2":1050,"y2":240,"swing":"in-left"},{"id":1765395877729.406,"type":"wall","x1":1110,"y1":240,"x2":1170,"y2":240,"swing":"in-left"},{"id":1765395882367,"type":"door-closed","x1":1050,"y1":240,"x2":1110,"y2":240,"swing":"in-left"},{"id":1765395885917.7773,"type":"wall","x1":930,"y1":60,"x2":930,"y2":90,"swing":"in-left"},{"id":1765395885970.2317,"type":"wall","x1":930,"y1":150,"x2":930,"y2":240,"swing":"in-left"},{"id":1765395890587,"type":"door-closed","x1":930,"y1":150,"x2":930,"y2":90,"swing":"in-left"},{"id":1765395896051,"type":"wall","x1":630,"y1":240,"x2":660,"y2":240,"swing":"in-left"},{"id":1765395899226,"type":"wall","x1":750,"y1":240,"x2":720,"y2":240,"swing":"in-left"},{"id":1765395902652,"type":"door-closed","x1":660,"y1":240,"x2":720,"y2":240,"swing":"in-left"},{"id":1765395909473.178,"type":"wall","x1":630,"y1":600,"x2":630,"y2":660,"swing":"in-left"},{"id":1765395913236.385,"type":"wall","x1":630,"y1":450,"x2":630,"y2":540,"swing":"in-left"},{"id":1765395913297.4053,"type":"wall","x1":630,"y1":360,"x2":630,"y2":390,"swing":"in-left"},{"id":1765395915562.4924,"type":"wall","x1":630,"y1":360,"x2":600,"y2":360,"swing":"in-left"},{"id":1765395917960.3071,"type":"wall","x1":540,"y1":360,"x2":450,"y2":360,"swing":"in-left"},{"id":1765395923862.8608,"type":"wall","x1":390,"y1":330,"x2":390,"y2":210,"swing":"in-left"},{"id":1765395924045.4658,"type":"wall","x1":390,"y1":840,"x2":390,"y2":390,"swing":"in-left"},{"id":1765395927287,"type":"wall","x1":390,"y1":330,"x2":390,"y2":390,"swing":"in-left"},{"id":1765395929870,"type":"door-closed","x1":390,"y1":360,"x2":450,"y2":360,"swing":"in-left"},{"id":1765395931458,"type":"door-closed","x1":540,"y1":360,"x2":600,"y2":360,"swing":"in-left"},{"id":1765395933272,"type":"door-closed","x1":630,"y1":390,"x2":630,"y2":450,"swing":"in-left"},{"id":1765395935183,"type":"door-closed","x1":630,"y1":540,"x2":630,"y2":600,"swing":"in-left"},{"id":1765395939914.6934,"type":"wall","x1":390,"y1":510,"x2":420,"y2":510,"swing":"in-left"},{"id":1765395942340.2908,"type":"wall","x1":600,"y1":510,"x2":630,"y2":510,"swing":"in-left"},{"id":1765395942995.5398,"type":"wall","x1":480,"y1":510,"x2":540,"y2":510,"swing":"in-left"},{"id":1765395945966,"type":"door-closed","x1":420,"y1":510,"x2":480,"y2":510,"swing":"in-left"},{"id":1765395947668,"type":"door-closed","x1":540,"y1":510,"x2":600,"y2":510,"swing":"in-left"},{"id":1765395960642.4734,"type":"wall","x1":630,"y1":120,"x2":630,"y2":60,"swing":"in-left"},{"id":1765395961265.808,"type":"wall","x1":630,"y1":240,"x2":630,"y2":180,"swing":"in-left"},{"id":1765395964484,"type":"door-closed","x1":630,"y1":120,"x2":630,"y2":180,"swing":"in-left"},{"id":1765395968042.526,"type":"wall","x1":390,"y1":240,"x2":540,"y2":240,"swing":"in-left"},{"id":1765395968767.9,"type":"wall","x1":600,"y1":240,"x2":630,"y2":240,"swing":"in-left"},{"id":1765395972721,"type":"door-closed","x1":540,"y1":240,"x2":600,"y2":240,"swing":"in-left"},{"id":1765395981146.952,"type":"wall","x1":480,"y1":660,"x2":390,"y2":660,"swing":"in-left"},{"id":1765395981479.733,"type":"wall","x1":630,"y1":660,"x2":540,"y2":660,"swing":"in-left"},{"id":1765395984267,"type":"door-closed","x1":480,"y1":660,"x2":540,"y2":660,"swing":"in-left"}],"drawings":[]},'small-house':{"name":"Small House","entities":[{"id":1,"type":"wall","x1":100,"y1":100,"x2":400,"y2":100},{"id":2,"type":"wall","x1":400,"y1":100,"x2":400,"y2":400},{"id":3,"type":"wall","x1":400,"y1":400,"x2":100,"y2":400},{"id":4,"type":"wall","x1":100,"y1":400,"x2":100,"y2":100},{"id":5,"type":"wall","x1":250,"y1":100,"x2":250,"y2":280},{"id":6,"type":"door-closed","x1":250,"y1":280,"x2":250,"y2":340,"swing":"in-right"},{"id":7,"type":"wall","x1":250,"y1":340,"x2":250,"y2":400},{"id":8,"type":"door-closed","x1":100,"y1":220,"x2":100,"y2":280,"swing":"in-right"},{"id":10,"type":"threat","x":340,"y":200,"direction":3.14,"fovAngle":60,"fovRange":180,"path":[]},{"id":11,"type":"civilian","x":340,"y":340,"direction":3.14,"path":[]},{"id":12,"type":"operator","x":50,"y":250,"color":"#4CAF50","label":"1","direction":0,"fovAngle":90,"fovRange":200,"path":[]},{"id":13,"type":"operator","x":50,"y":300,"color":"#2196F3","label":"2","direction":0,"fovAngle":90,"fovRange":200,"path":[]}],"drawings":[]},'l-corridor':{"name":"L-Corridor","entities":[{"id":1,"type":"wall","x1":100,"y1":100,"x2":200,"y2":100},{"id":2,"type":"wall","x1":200,"y1":100,"x2":200,"y2":250},{"id":3,"type":"wall","x1":200,"y1":250,"x2":450,"y2":250},{"id":4,"type":"wall","x1":450,"y1":250,"x2":450,"y2":350},{"id":5,"type":"wall","x1":450,"y1":350,"x2":200,"y2":350},{"id":6,"type":"wall","x1":200,"y1":350,"x2":200,"y2":500},{"id":7,"type":"wall","x1":200,"y1":500,"x2":100,"y2":500},{"id":8,"type":"wall","x1":100,"y1":500,"x2":100,"y2":100},{"id":12,"type":"threat","x":420,"y":300,"direction":3.14,"fovAngle":70,"fovRange":180,"path":[]},{"id":13,"type":"threat","x":150,"y":450,"direction":-1.57,"fovAngle":60,"fovRange":150,"path":[]},{"id":14,"type":"operator","x":150,"y":130,"color":"#4CAF50","label":"1","direction":1.57,"fovAngle":90,"fovRange":200,"path":[]},{"id":15,"type":"operator","x":120,"y":130,"color":"#2196F3","label":"2","direction":1.57,"fovAngle":90,"fovRange":200,"path":[]}],"drawings":[]},'apartment':{"name":"Apartment","entities":[{"id":1,"type":"wall","x1":100,"y1":100,"x2":500,"y2":100},{"id":2,"type":"wall","x1":500,"y1":100,"x2":500,"y2":400},{"id":3,"type":"wall","x1":500,"y1":400,"x2":100,"y2":400},{"id":4,"type":"wall","x1":100,"y1":400,"x2":100,"y2":100},{"id":5,"type":"wall","x1":250,"y1":100,"x2":250,"y2":200},{"id":6,"type":"door-closed","x1":250,"y1":200,"x2":250,"y2":260,"swing":"in-left"},{"id":7,"type":"wall","x1":250,"y1":260,"x2":250,"y2":400},{"id":8,"type":"wall","x1":350,"y1":100,"x2":350,"y2":180},{"id":9,"type":"door-closed","x1":350,"y1":180,"x2":350,"y2":240,"swing":"in-right"},{"id":10,"type":"wall","x1":350,"y1":240,"x2":350,"y2":300},{"id":11,"type":"wall","x1":350,"y1":300,"x2":500,"y2":300},{"id":12,"type":"door-closed","x1":100,"y1":200,"x2":100,"y2":260,"swing":"in-right"},{"id":15,"type":"threat","x":300,"y":150,"direction":3.14,"fovAngle":80,"fovRange":180,"path":[]},{"id":16,"type":"threat","x":420,"y":200,"direction":2.5,"fovAngle":60,"fovRange":160,"path":[]},{"id":17,"type":"civilian","x":420,"y":350,"direction":1.57,"path":[]},{"id":19,"type":"operator","x":50,"y":220,"color":"#4CAF50","label":"1","direction":0,"fovAngle":90,"fovRange":200,"path":[]},{"id":20,"type":"operator","x":50,"y":250,"color":"#2196F3","label":"2","direction":0,"fovAngle":90,"fovRange":200,"path":[]}],"drawings":[]},'warehouse':{"name":"Warehouse","entities":[{"id":1,"type":"wall","x1":50,"y1":50,"x2":550,"y2":50},{"id":2,"type":"wall","x1":550,"y1":50,"x2":550,"y2":450},{"id":3,"type":"wall","x1":550,"y1":450,"x2":50,"y2":450},{"id":4,"type":"wall","x1":50,"y1":450,"x2":50,"y2":50},{"id":5,"type":"wall","x1":150,"y1":120,"x2":150,"y2":200},{"id":6,"type":"wall","x1":150,"y1":120,"x2":220,"y2":120},{"id":7,"type":"wall","x1":150,"y1":280,"x2":150,"y2":380},{"id":8,"type":"wall","x1":150,"y1":280,"x2":220,"y2":280},{"id":17,"type":"door-open","x1":50,"y1":220,"x2":50,"y2":280,"swing":"in-right"},{"id":18,"type":"threat","x":180,"y":160,"direction":0.5,"fovAngle":70,"fovRange":180,"path":[]},{"id":19,"type":"threat","x":340,"y":200,"direction":3.5,"fovAngle":60,"fovRange":160,"path":[]},{"id":20,"type":"threat","x":340,"y":350,"direction":2.5,"fovAngle":70,"fovRange":180,"path":[]},{"id":22,"type":"operator","x":20,"y":230,"color":"#4CAF50","label":"1","direction":0,"fovAngle":90,"fovRange":200,"path":[]},{"id":23,"type":"operator","x":20,"y":260,"color":"#2196F3","label":"2","direction":0,"fovAngle":90,"fovRange":200,"path":[]},{"id":24,"type":"operator","x":20,"y":290,"color":"#FF9800","label":"3","direction":0,"fovAngle":90,"fovRange":200,"path":[]}],"drawings":[]}};

const canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d');
function resize(){const c=document.querySelector('.main');canvas.width=c.clientWidth;canvas.height=c.clientHeight;draw();}
window.addEventListener('resize',resize);resize();

function s2w(x,y){return{x:(x-S.panX)/S.zoom,y:(y-S.panY)/S.zoom};}
function snap(v){return Math.round(v/S.gridSize)*S.gridSize;}
function mPos(e){const r=canvas.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top};}

function save(){const snap=JSON.stringify({entities:S.entities.map(e=>({...e,cx:undefined,cy:undefined,cd:undefined})),drawings:S.drawings});S.history=S.history.slice(0,S.historyIdx+1);S.history.push(snap);if(S.history.length>50)S.history.shift();S.historyIdx=S.history.length-1;}
function undo(){if(S.historyIdx>0){S.historyIdx--;const s=JSON.parse(S.history[S.historyIdx]);S.entities=s.entities;S.drawings=s.drawings;S.selected=null;draw();}}
function redo(){if(S.historyIdx<S.history.length-1){S.historyIdx++;const s=JSON.parse(S.history[S.historyIdx]);S.entities=s.entities;S.drawings=s.drawings;S.selected=null;draw();}}

function findAt(x,y){for(let i=S.drawings.length-1;i>=0;i--){const d=S.drawings[i];if(d.type==='pen'){for(const p of d.points)if(Math.hypot(x-p.x,y-p.y)<10/S.zoom+d.size)return{type:'drawing',item:d,idx:i};}}for(let i=S.entities.length-1;i>=0;i--){const e=S.entities[i];if([E.WALL,E.DOOR_C,E.DOOR_O].includes(e.type)){if(distSeg(x,y,e.x1,e.y1,e.x2,e.y2)<10)return{type:'entity',item:e,idx:i};}if([E.OP,E.THREAT,E.CIV].includes(e.type)){const ex=e.cx!==undefined?e.cx:e.x,ey=e.cy!==undefined?e.cy:e.y;if(Math.hypot(x-ex,y-ey)<=15)return{type:'entity',item:e,idx:i};}}return null;}

function distSeg(px,py,x1,y1,x2,y2){const A=px-x1,B=py-y1,C=x2-x1,D=y2-y1,dot=A*C+B*D,len=C*C+D*D;let t=len?dot/len:-1;if(t<0){return Math.hypot(px-x1,py-y1);}if(t>1){return Math.hypot(px-x2,py-y2);}return Math.hypot(px-(x1+t*C),py-(y1+t*D));}

function pathLen(p){if(!p||p.length<2)return 0;let l=0;for(let i=1;i<p.length;i++)l+=Math.hypot(p[i].x-p[i-1].x,p[i].y-p[i-1].y);return l;}
function posOnPath(p,d){if(!p||!p.length)return null;if(p.length===1)return{x:p[0].x,y:p[0].y};let t=0;for(let i=1;i<p.length;i++){const seg=Math.hypot(p[i].x-p[i-1].x,p[i].y-p[i-1].y);if(t+seg>=d){const r=(d-t)/seg;return{x:p[i-1].x+r*(p[i].x-p[i-1].x),y:p[i-1].y+r*(p[i].y-p[i-1].y)};}t+=seg;}return{x:p[p.length-1].x,y:p[p.length-1].y};}

function simplify(pts,tol=3){if(pts.length<=2)return pts;let mx=0,mi=0;const f=pts[0],l=pts[pts.length-1];for(let i=1;i<pts.length-1;i++){const d=perpDist(pts[i],f,l);if(d>mx){mx=d;mi=i;}}if(mx>tol){const left=simplify(pts.slice(0,mi+1),tol),right=simplify(pts.slice(mi),tol);return left.slice(0,-1).concat(right);}return[f,l];}
function perpDist(p,a,b){const dx=b.x-a.x,dy=b.y-a.y,len=dx*dx+dy*dy;if(!len)return Math.hypot(p.x-a.x,p.y-a.y);const t=Math.max(0,Math.min(1,((p.x-a.x)*dx+(p.y-a.y)*dy)/len));return Math.hypot(p.x-(a.x+t*dx),p.y-(a.y+t*dy));}

function lineInt(p1,p2,p3,p4){const d=(p4.y-p3.y)*(p2.x-p1.x)-(p4.x-p3.x)*(p2.y-p1.y);if(Math.abs(d)<0.0001)return null;const ua=((p4.x-p3.x)*(p1.y-p3.y)-(p4.y-p3.y)*(p1.x-p3.x))/d,ub=((p2.x-p1.x)*(p1.y-p3.y)-(p2.y-p1.y)*(p1.x-p3.x))/d;if(ua>=0&&ua<=1&&ub>=0&&ub<=1)return{x:p1.x+ua*(p2.x-p1.x),y:p1.y+ua*(p2.y-p1.y)};return null;}
function wallHit(x1,y1,x2,y2){let hit=null,best=Infinity;for(const e of S.entities){if(e.type===E.WALL){const h=lineInt({x:x1,y:y1},{x:x2,y:y2},{x:e.x1,y:e.y1},{x:e.x2,y:e.y2});if(h){const d=Math.hypot(h.x-x1,h.y-y1);if(d<best&&d>1){best=d;hit=h;}}}}return hit;}
function linesOverlap(ax1,ay1,ax2,ay2,bx1,by1,bx2,by2){const tol=5;const aAng=Math.atan2(ay2-ay1,ax2-ax1);const bAng=Math.atan2(by2-by1,bx2-bx1);let angDiff=Math.abs(aAng-bAng);if(angDiff>Math.PI)angDiff=2*Math.PI-angDiff;if(angDiff>0.1&&angDiff<Math.PI-0.1)return false;const distToLine=(px,py,lx1,ly1,lx2,ly2)=>{const len=Math.hypot(lx2-lx1,ly2-ly1);if(len<1)return Math.hypot(px-lx1,py-ly1);const t=Math.max(0,Math.min(1,((px-lx1)*(lx2-lx1)+(py-ly1)*(ly2-ly1))/(len*len)));return Math.hypot(px-(lx1+t*(lx2-lx1)),py-(ly1+t*(ly2-ly1)));};if(distToLine(bx1,by1,ax1,ay1,ax2,ay2)>tol&&distToLine(bx2,by2,ax1,ay1,ax2,ay2)>tol)return false;const proj=(px,py,lx1,ly1,lx2,ly2)=>{const len=Math.hypot(lx2-lx1,ly2-ly1);if(len<1)return 0;return((px-lx1)*(lx2-lx1)+(py-ly1)*(ly2-ly1))/(len*len);};const t1=proj(bx1,by1,ax1,ay1,ax2,ay2),t2=proj(bx2,by2,ax1,ay1,ax2,ay2);const minT=Math.min(t1,t2),maxT=Math.max(t1,t2);return maxT>-0.1&&minT<1.1;}
function wallHitForPath(x1,y1,x2,y2){let hit=null,best=Infinity;for(const e of S.entities){if(e.type===E.WALL){const h=lineInt({x:x1,y:y1},{x:x2,y:y2},{x:e.x1,y:e.y1},{x:e.x2,y:e.y2});if(h){const d=Math.hypot(h.x-x1,h.y-y1);if(d<best&&d>1){best=d;hit=h;}}}}return hit;}
function eraseAt(x,y){const gs=S.gridSize;const gx=Math.floor(x/gs)*gs;const gy=Math.floor(y/gs)*gs;for(let i=S.drawings.length-1;i>=0;i--){const d=S.drawings[i];if(d.type==='pen'&&d.points){for(const p of d.points){if(p.x>=gx&&p.x<gx+gs&&p.y>=gy&&p.y<gy+gs){S.drawings.splice(i,1);break;}}}}for(let i=S.entities.length-1;i>=0;i--){const e=S.entities[i];if([E.WALL,E.DOOR_C,E.DOOR_O].includes(e.type)){const hit=lineInt({x:gx,y:gy},{x:gx+gs,y:gy},{x:e.x1,y:e.y1},{x:e.x2,y:e.y2})||lineInt({x:gx+gs,y:gy},{x:gx+gs,y:gy+gs},{x:e.x1,y:e.y1},{x:e.x2,y:e.y2})||lineInt({x:gx+gs,y:gy+gs},{x:gx,y:gy+gs},{x:e.x1,y:e.y1},{x:e.x2,y:e.y2})||lineInt({x:gx,y:gy+gs},{x:gx,y:gy},{x:e.x1,y:e.y1},{x:e.x2,y:e.y2});const inside=(e.x1>=gx&&e.x1<gx+gs&&e.y1>=gy&&e.y1<gy+gs)||(e.x2>=gx&&e.x2<gx+gs&&e.y2>=gy&&e.y2<gy+gs);if(hit||inside){const len=Math.hypot(e.x2-e.x1,e.y2-e.y1);if(len<1)continue;const dx=(e.x2-e.x1)/len;const dy=(e.y2-e.y1)/len;let tMin=0,tMax=1;const clips=[[gx,gx+gs,dx,e.x1],[gy,gy+gs,dy,e.y1]];for(let c=0;c<2;c++){const lo=clips[c][0],hi=clips[c][1],d=clips[c][2],o=clips[c][3];if(Math.abs(d)>0.001){const t1=(lo-o)/(d*len),t2=(hi-o)/(d*len);const tEnter=Math.min(t1,t2),tExit=Math.max(t1,t2);tMin=Math.max(tMin,tEnter);tMax=Math.min(tMax,tExit);}}if(tMin<tMax){const newSegs=[];if(tMin>0.01){newSegs.push({id:Date.now()+Math.random(),type:e.type,x1:e.x1,y1:e.y1,x2:e.x1+tMin*len*dx,y2:e.y1+tMin*len*dy,swing:e.swing});}if(tMax<0.99){newSegs.push({id:Date.now()+Math.random()+1,type:e.type,x1:e.x1+tMax*len*dx,y1:e.y1+tMax*len*dy,x2:e.x2,y2:e.y2,swing:e.swing});}S.entities.splice(i,1);for(const seg of newSegs){S.entities.push(seg);}}}}if([E.OP,E.THREAT,E.CIV].includes(e.type)){const ex=e.cx!==undefined?e.cx:e.x;const ey=e.cy!==undefined?e.cy:e.y;if(ex>=gx&&ex<gx+gs&&ey>=gy&&ey<gy+gs){S.entities.splice(i,1);}}}}
function castRay(ox,oy,ang,maxD){const ex=ox+Math.cos(ang)*maxD,ey=oy+Math.sin(ang)*maxD;let cd=maxD;for(const e of S.entities){if(e.type===E.WALL||e.type===E.DOOR_C){const h=lineInt({x:ox,y:oy},{x:ex,y:ey},{x:e.x1,y:e.y1},{x:e.x2,y:e.y2});if(h){const d=Math.hypot(h.x-ox,h.y-oy);if(d<cd)cd=d;}}}return cd;}
function smooth(pts,segs=5){if(pts.length<3)return pts;const r=[pts[0]];for(let i=0;i<pts.length-1;i++){const p0=pts[Math.max(0,i-1)],p1=pts[i],p2=pts[Math.min(pts.length-1,i+1)],p3=pts[Math.min(pts.length-1,i+2)];for(let t=1;t<=segs;t++){const t1=t/segs,t2=t1*t1,t3=t2*t1;r.push({x:0.5*((2*p1.x)+(-p0.x+p2.x)*t1+(2*p0.x-5*p1.x+4*p2.x-p3.x)*t2+(-p0.x+3*p1.x-3*p2.x+p3.x)*t3),y:0.5*((2*p1.y)+(-p0.y+p2.y)*t1+(2*p0.y-5*p1.y+4*p2.y-p3.y)*t2+(-p0.y+3*p1.y-3*p2.y+p3.y)*t3)});}}return r;}

let originalDoorStates=[];
let pendingVTAs={};
function startPlay(){if(S.playing)return;const hasVTAPaths=S.entities.some(e=>e.vtaPending&&e.vtaPath);const hasDoorOpenPaths=S.entities.some(e=>e.doorOpenPending&&e.doorOpenPath);if(!S.entities.some(e=>e.path&&e.path.length>1)&&Object.keys(S.queuedDoorActions).length===0&&!hasVTAPaths&&!hasDoorOpenPaths)return;S.playing=true;document.getElementById('playBtn').textContent='‚è∏';document.getElementById('playBtn').classList.add('playing');S.playTime=0;originalDoorStates=S.entities.filter(e=>e.type===E.DOOR_C||e.type===E.DOOR_O).map(e=>({id:e.id,type:e.type}));S.entities.forEach(e=>{if(e.doorOpenPending&&e.doorOpenPath){e.path=e.doorOpenPath;e.lookPoints=e.doorOpenLookPoints||[];e.doorOpenPending=false;e.isDoorOpenPath=true;e.cx=e.x;e.cy=e.y;e.cd=e.direction;}else if(e.vtaPending&&e.vtaPath&&!Object.values(S.queuedDoorActions).some(a=>a.action==='open-vta')){e.path=e.vtaPath;e.lookPoints=e.vtaLookPoints||[];e.vtaPending=false;e.cx=e.x;e.cy=e.y;e.cd=e.direction;delete e.vtaPath;delete e.vtaLookPoints;}else if(e.path&&e.path.length){e.cx=e.x;e.cy=e.y;e.cd=e.direction;}});lastFrame=performance.now();animate();}
function stopPlay(done){S.playing=false;document.getElementById('playBtn').textContent='‚ñ∂ Play';document.getElementById('playBtn').classList.remove('playing');if(S.animFrame)cancelAnimationFrame(S.animFrame);S.doorAnims={};if(done){S.queuedDoorActions={};S.entities.forEach(e=>{if(e.path&&e.path.length>1){if(e.cx!==undefined)e.x=e.cx;if(e.cy!==undefined)e.y=e.cy;if(e.cd!==undefined)e.direction=e.cd;e.path=[];e.lookPoints=[];}delete e.vtaPath;delete e.vtaLookPoints;delete e.vtaPending;delete e.doorOpenPath;delete e.doorOpenLookPoints;delete e.doorOpenPending;delete e.doorOpenFrame;delete e.doorOpenDoorId;delete e.doorOpenWithVTA;delete e.vtaPathAfter;delete e.vtaLookPointsAfter;delete e.isDoorOpenPath;delete e.isVTAPath;delete e.doorDuration;delete e.isReachAcross;});S.playTime=0;save();}else{originalDoorStates.forEach(ds=>{const door=S.entities.find(e=>e.id===ds.id);if(door)door.type=ds.type;});S.entities.forEach(e=>{if([E.OP,E.THREAT,E.CIV].includes(e.type)){e.cx=e.x;e.cy=e.y;e.cd=e.direction;e.path=[];e.lookPoints=[];}});draw();}}
function rewind(){stopPlay(false);S.playTime=0;S.doorAnims={};originalDoorStates.forEach(ds=>{const door=S.entities.find(e=>e.id===ds.id);if(door)door.type=ds.type;});S.entities.forEach(e=>{e.cx=e.x;e.cy=e.y;e.cd=e.direction;});draw();}
let lastFrame=0;const SPEED=100;
function animate(){if(!S.playing)return;const now=performance.now(),dt=(now-lastFrame)/1000;lastFrame=now;S.playTime+=dt*S.playSpeed;const dist=S.playTime*SPEED;const slowDist=S.playTime*SPEED*0.32;let done=true;const hasActiveDoorAnims=Object.keys(S.doorAnims).length>0;if(hasActiveDoorAnims)done=false;S.entities.forEach(e=>{if(e.path&&e.path.length>1){const pl=pathLen(e.path);const useDist=(e.isVTAPath||e.isDoorOpenPath)?slowDist:dist;if(useDist<pl){done=false;const pos=posOnPath(e.path,useDist);const prevPos=e.cx!==undefined?{x:e.cx,y:e.cy}:{x:e.x,y:e.y};if(!e.isDoorOpenPath)checkDoorCollision(prevPos,pos);e.cx=pos.x;e.cy=pos.y;if(e.isDoorOpenPath&&e.doorOpenFrame&&e.doorOpenDoorId){const frameThreshold=pathLen(e.path.slice(0,e.doorOpenFrame+1));if(useDist>=frameThreshold&&!S.doorAnims[e.doorOpenDoorId]){const door=S.entities.find(d=>d.id===e.doorOpenDoorId);if(door&&door.type===E.DOOR_C){S.doorAnims[door.id]={startTime:performance.now(),duration:e.doorDuration||400};}}}let baseDir=e.direction;let idx=0,tr=0;for(let i=1;i<e.path.length;i++){const seg=Math.hypot(e.path[i].x-e.path[i-1].x,e.path[i].y-e.path[i-1].y);if(tr+seg>=useDist){idx=i;break;}tr+=seg;}if(idx>0)baseDir=Math.atan2(e.path[idx].y-e.path[idx-1].y,e.path[idx].x-e.path[idx-1].x);if(e.lookPoints&&e.lookPoints.length>0){let prevLp=null,nextLp=null;for(const lp of e.lookPoints){if(lp.distance<=useDist)prevLp=lp;if(lp.distance>useDist&&!nextLp)nextLp=lp;}if(prevLp&&nextLp){const t=(useDist-prevLp.distance)/(nextLp.distance-prevLp.distance);let diff=nextLp.direction-prevLp.direction;while(diff>Math.PI)diff-=2*Math.PI;while(diff<-Math.PI)diff+=2*Math.PI;e.cd=prevLp.direction+t*diff;}else if(prevLp){e.cd=prevLp.direction;}else if(nextLp){const t=useDist/nextLp.distance;let diff=nextLp.direction-e.direction;while(diff>Math.PI)diff-=2*Math.PI;while(diff<-Math.PI)diff+=2*Math.PI;e.cd=e.direction+t*diff;}else{e.cd=baseDir;}}else{e.cd=baseDir;}}else{e.cx=e.path[e.path.length-1].x;e.cy=e.path[e.path.length-1].y;if(e.lookPoints&&e.lookPoints.length>0){e.cd=e.lookPoints[e.lookPoints.length-1].direction;}if(e.isDoorOpenPath){delete e.isDoorOpenPath;delete e.doorOpenFrame;delete e.doorOpenDoorId;if(e.doorOpenWithVTA&&e.vtaPathAfter){e.path=e.vtaPathAfter;e.lookPoints=e.vtaLookPointsAfter||[];e.isVTAPath=true;e.cx=e.path[0].x;e.cy=e.path[0].y;delete e.vtaPathAfter;delete e.vtaLookPointsAfter;delete e.doorOpenWithVTA;S.playTime=0;done=false;}else{e.path=[];e.lookPoints=[];delete e.doorOpenWithVTA;}}else{delete e.isVTAPath;}}}});draw();if(done)stopPlay(true);else S.animFrame=requestAnimationFrame(animate);}

function checkDoorCollision(from,to){for(let i=0;i<S.entities.length;i++){const e=S.entities[i];if(e.type===E.DOOR_C&&!S.doorAnims[e.id]){const hit=lineInt(from,to,{x:e.x1,y:e.y1},{x:e.x2,y:e.y2});if(hit){S.doorAnims[e.id]={startTime:performance.now(),duration:300};}}}}

function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#1a1a1a';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.save();ctx.translate(S.panX,S.panY);ctx.scale(S.zoom,S.zoom);if(S.showGrid)drawGrid();S.drawings.forEach(d=>drawD(d,S.selected?.item===d));S.entities.filter(e=>[E.WALL,E.DOOR_C,E.DOOR_O].includes(e.type)).forEach(e=>drawE(e,S.selected?.item===e));S.entities.filter(e=>e.path&&e.path.length>1).forEach(e=>drawPath(e));S.entities.filter(e=>e.vtaPath&&e.vtaPending).forEach(e=>drawVTAPath(e));S.entities.filter(e=>e.doorOpenPath&&e.doorOpenPending).forEach(e=>drawDoorOpenPath(e));S.entities.filter(e=>[E.OP,E.THREAT,E.CIV].includes(e.type)).forEach(e=>drawE(e,S.selected?.item===e));if(S.drawing&&S.path.length)drawCur();if(S.draggingLookPoint){const lp=S.draggingLookPoint;ctx.fillStyle='#ffeb3b';ctx.beginPath();ctx.arc(lp.pathPt.x,lp.pathPt.y,6,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#ffeb3b';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(lp.pathPt.x,lp.pathPt.y);ctx.lineTo(lp.pathPt.x+Math.cos(lp.currentDir)*40,lp.pathPt.y+Math.sin(lp.currentDir)*40);ctx.stroke();const arrowX=lp.pathPt.x+Math.cos(lp.currentDir)*40;const arrowY=lp.pathPt.y+Math.sin(lp.currentDir)*40;ctx.fillStyle='#ffeb3b';ctx.beginPath();ctx.moveTo(arrowX,arrowY);ctx.lineTo(arrowX-Math.cos(lp.currentDir-0.4)*10,arrowY-Math.sin(lp.currentDir-0.4)*10);ctx.lineTo(arrowX-Math.cos(lp.currentDir+0.4)*10,arrowY-Math.sin(lp.currentDir+0.4)*10);ctx.closePath();ctx.fill();}ctx.restore();}

function drawGrid(){const b=getBounds(),sx=Math.floor(b.minX/S.gridSize)*S.gridSize,sy=Math.floor(b.minY/S.gridSize)*S.gridSize;ctx.strokeStyle='#2a2a2a';ctx.lineWidth=1/S.zoom;for(let x=sx;x<=b.maxX;x+=S.gridSize){ctx.beginPath();ctx.moveTo(x,b.minY);ctx.lineTo(x,b.maxY);ctx.stroke();}for(let y=sy;y<=b.maxY;y+=S.gridSize){ctx.beginPath();ctx.moveTo(b.minX,y);ctx.lineTo(b.maxX,y);ctx.stroke();}}
function getBounds(){const tl=s2w(0,0),br=s2w(canvas.width,canvas.height);return{minX:tl.x,minY:tl.y,maxX:br.x,maxY:br.y};}

function drawPath(e){const p=e.path;if(!p||p.length<2)return;const isSel=S.selected&&S.selected.item===e;ctx.save();ctx.strokeStyle=e.color||'#4CAF50';ctx.lineWidth=isSel?4:2;if(isSel){ctx.shadowColor=e.color||'#4CAF50';ctx.shadowBlur=8;}ctx.setLineDash([8,4]);ctx.beginPath();ctx.moveTo(p[0].x,p[0].y);for(let i=1;i<p.length;i++)ctx.lineTo(p[i].x,p[i].y);ctx.stroke();ctx.setLineDash([]);ctx.shadowBlur=0;const last=p[p.length-1],prev=p[p.length-2],ang=Math.atan2(last.y-prev.y,last.x-prev.x);ctx.fillStyle=e.color||'#4CAF50';ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(last.x-12*Math.cos(ang-0.4),last.y-12*Math.sin(ang-0.4));ctx.lineTo(last.x-12*Math.cos(ang+0.4),last.y-12*Math.sin(ang+0.4));ctx.closePath();ctx.fill();if(e.lookPoints&&e.lookPoints.length>0){for(const lp of e.lookPoints){const pos=posOnPath(p,lp.distance);if(pos){ctx.fillStyle=isSel?'#fff':'#ffeb3b';ctx.beginPath();ctx.arc(pos.x,pos.y,isSel?6:4,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#000';ctx.lineWidth=1;ctx.stroke();const lookDir=lp.direction;ctx.strokeStyle='#ffeb3b';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pos.x,pos.y);ctx.lineTo(pos.x+Math.cos(lookDir)*25,pos.y+Math.sin(lookDir)*25);ctx.stroke();ctx.beginPath();ctx.moveTo(pos.x+Math.cos(lookDir)*25,pos.y+Math.sin(lookDir)*25);ctx.lineTo(pos.x+Math.cos(lookDir)*20+Math.cos(lookDir+2.5)*8,pos.y+Math.sin(lookDir)*20+Math.sin(lookDir+2.5)*8);ctx.lineTo(pos.x+Math.cos(lookDir)*20+Math.cos(lookDir-2.5)*8,pos.y+Math.sin(lookDir)*20+Math.sin(lookDir-2.5)*8);ctx.closePath();ctx.fillStyle='#ffeb3b';ctx.fill();}}}ctx.restore();}

function drawVTAPath(e){const p=e.vtaPath;if(!p||p.length<2)return;ctx.save();ctx.strokeStyle='#9c27b0';ctx.lineWidth=2;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(p[0].x,p[0].y);for(let i=1;i<p.length;i++)ctx.lineTo(p[i].x,p[i].y);ctx.stroke();ctx.setLineDash([]);if(e.vtaLookPoints&&e.vtaLookPoints.length>0){for(const lp of e.vtaLookPoints){const pos=posOnPath(p,lp.distance);if(pos){ctx.fillStyle='#ce93d8';ctx.beginPath();ctx.arc(pos.x,pos.y,3,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#9c27b0';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(pos.x,pos.y);ctx.lineTo(pos.x+Math.cos(lp.direction)*15,pos.y+Math.sin(lp.direction)*15);ctx.stroke();}}}ctx.restore();}

function drawDoorOpenPath(e){const p=e.doorOpenPath;if(!p||p.length<2)return;ctx.save();ctx.strokeStyle='#FF9800';ctx.lineWidth=2;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(p[0].x,p[0].y);for(let i=1;i<p.length;i++)ctx.lineTo(p[i].x,p[i].y);ctx.stroke();ctx.setLineDash([]);if(e.doorOpenFrame){const framePos=p[e.doorOpenFrame];if(framePos){ctx.fillStyle='#FF9800';ctx.beginPath();ctx.arc(framePos.x,framePos.y,6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.font='bold 8px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('üö™',framePos.x,framePos.y);}}if(e.vtaPathAfter&&e.vtaPathAfter.length>1){ctx.strokeStyle='#9c27b0';ctx.setLineDash([4,4]);ctx.beginPath();const startPt=p[p.length-1];ctx.moveTo(startPt.x,startPt.y);for(let i=1;i<e.vtaPathAfter.length;i++)ctx.lineTo(e.vtaPathAfter[i].x,e.vtaPathAfter[i].y);ctx.stroke();ctx.setLineDash([]);}ctx.restore();}

function drawD(d,sel){if(d.type==='pen'&&d.points.length>=2){ctx.strokeStyle=sel?'#fff':d.color;ctx.lineWidth=d.size;ctx.lineCap='round';ctx.lineJoin='round';ctx.beginPath();ctx.moveTo(d.points[0].x,d.points[0].y);d.points.slice(1).forEach(p=>ctx.lineTo(p.x,p.y));ctx.stroke();}}

function drawCur(){ctx.lineCap='round';ctx.lineJoin='round';if(S.tool==='pen'){ctx.strokeStyle=S.drawColor;ctx.lineWidth=S.strokeSize;ctx.beginPath();ctx.moveTo(S.path[0].x,S.path[0].y);S.path.slice(1).forEach(p=>ctx.lineTo(p.x,p.y));ctx.stroke();}else if(S.tool==='path'&&S.selected){ctx.strokeStyle=S.selected.item.color||'#4CAF50';ctx.lineWidth=2;ctx.setLineDash([8,4]);ctx.beginPath();ctx.moveTo(S.selected.item.x,S.selected.item.y);S.path.forEach(p=>ctx.lineTo(p.x,p.y));ctx.stroke();ctx.setLineDash([]);}else if(S.drawStart&&S.path.length){const end=S.path[S.path.length-1];ctx.strokeStyle=S.tool==='wall'?'#8892b0':S.tool==='door-open'?'#4CAF50':'#cd853f';ctx.lineWidth=S.tool==='wall'?6:5;ctx.beginPath();ctx.moveTo(S.drawStart.x,S.drawStart.y);ctx.lineTo(end.x,end.y);ctx.stroke();}}

function drawE(e,sel){if(e.type===E.WALL){ctx.strokeStyle=sel?'#fff':'#8892b0';ctx.lineWidth=6;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(e.x1,e.y1);ctx.lineTo(e.x2,e.y2);ctx.stroke();}else if(e.type===E.DOOR_C){const doorLen=Math.hypot(e.x2-e.x1,e.y2-e.y1);const doorAng=Math.atan2(e.y2-e.y1,e.x2-e.x1);const swing=e.swing||'in-left';const pivotX=swing.includes('left')?e.x1:e.x2;const pivotY=swing.includes('left')?e.y1:e.y2;const handleX=swing.includes('left')?e.x2:e.x1;const handleY=swing.includes('left')?e.y2:e.y1;const swingDir=swing.includes('in')?1:-1;const baseAng=swing.includes('left')?doorAng:doorAng+Math.PI;const openAmount=getDoorMaxOpenAngle(e);const anim=S.doorAnims[e.id];let openProgress=0;if(anim&&!anim.closing){const elapsed=performance.now()-anim.startTime;openProgress=Math.min(1,elapsed/anim.duration);if(openProgress>=1){const idx=S.entities.findIndex(x=>x.id===e.id);if(idx>=0)S.entities[idx]={...e,type:E.DOOR_O};if(anim.triggerVTA){for(const op of S.entities){if(op.vtaPending&&op.vtaPath){op.path=op.vtaPath;op.lookPoints=op.vtaLookPoints||[];op.vtaPending=false;op.cx=op.x;op.cy=op.y;op.cd=op.direction;delete op.vtaPath;delete op.vtaLookPoints;}}}delete S.doorAnims[e.id];}}const currentAng=baseAng+swingDir*openAmount*openProgress;ctx.strokeStyle='#555';ctx.lineWidth=2;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(e.x1,e.y1);ctx.lineTo(e.x2,e.y2);ctx.stroke();ctx.setLineDash([]);ctx.strokeStyle=sel?'#fff':'#cd853f';ctx.lineWidth=5;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(pivotX,pivotY);ctx.lineTo(pivotX+Math.cos(currentAng)*doorLen,pivotY+Math.sin(currentAng)*doorLen);ctx.stroke();const curHandleX=pivotX+Math.cos(currentAng)*doorLen*0.85;const curHandleY=pivotY+Math.sin(currentAng)*doorLen*0.85;ctx.fillStyle='#ffd700';ctx.beginPath();ctx.arc(curHandleX,curHandleY,4,0,Math.PI*2);ctx.fill();if(openProgress===0){const handleDist=doorLen*0.85;const handlePosX=pivotX+Math.cos(baseAng)*handleDist;const handlePosY=pivotY+Math.sin(baseAng)*handleDist;const arrowLen=S.gridSize;ctx.strokeStyle='rgba(76,175,80,0.7)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(pivotX,pivotY,handleDist,baseAng,baseAng+swingDir*0.8,swingDir<0);ctx.stroke();const arrowEndAng=baseAng+swingDir*0.8;const arrowEndX=pivotX+Math.cos(arrowEndAng)*handleDist;const arrowEndY=pivotY+Math.sin(arrowEndAng)*handleDist;const arrowTipDir=arrowEndAng+swingDir*Math.PI/2;ctx.fillStyle='rgba(76,175,80,0.8)';ctx.beginPath();ctx.moveTo(arrowEndX,arrowEndY);ctx.lineTo(arrowEndX-Math.cos(arrowTipDir-0.5)*10,arrowEndY-Math.sin(arrowTipDir-0.5)*10);ctx.lineTo(arrowEndX-Math.cos(arrowTipDir+0.5)*10,arrowEndY-Math.sin(arrowTipDir+0.5)*10);ctx.closePath();ctx.fill();}const queued=S.queuedDoorActions[e.id];if(queued&&(queued.action==='open'||queued.action==='open-vta')){const midX=(e.x1+e.x2)/2;const midY=(e.y1+e.y2)/2;ctx.fillStyle=queued.action==='open-vta'?'rgba(156,39,176,0.9)':'rgba(255,152,0,0.9)';ctx.beginPath();ctx.arc(midX,midY,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.font='bold 10px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(queued.action==='open-vta'?'VTA':'‚ñ∂',midX,midY);}}else if(e.type===E.DOOR_O){const doorLen=Math.hypot(e.x2-e.x1,e.y2-e.y1);const doorAng=Math.atan2(e.y2-e.y1,e.x2-e.x1);const swing=e.swing||'in-left';const pivotX=swing.includes('left')?e.x1:e.x2;const pivotY=swing.includes('left')?e.y1:e.y2;const swingDir=swing.includes('in')?1:-1;const baseAng=swing.includes('left')?doorAng:doorAng+Math.PI;const openAmount=getDoorMaxOpenAngle(e);const anim=S.doorAnims[e.id];let closeProgress=0;if(anim&&anim.closing){const elapsed=performance.now()-anim.startTime;closeProgress=Math.min(1,elapsed/anim.duration);if(closeProgress>=1){const idx=S.entities.findIndex(x=>x.id===e.id);if(idx>=0)S.entities[idx]={...e,type:E.DOOR_C};delete S.doorAnims[e.id];}}const openAng=baseAng+swingDir*openAmount;const currentAng=openAng-swingDir*openAmount*closeProgress;ctx.strokeStyle='#555';ctx.lineWidth=2;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(e.x1,e.y1);ctx.lineTo(e.x2,e.y2);ctx.stroke();ctx.setLineDash([]);ctx.strokeStyle=sel?'#fff':'#4CAF50';ctx.lineWidth=4;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(pivotX,pivotY);ctx.lineTo(pivotX+Math.cos(currentAng)*doorLen,pivotY+Math.sin(currentAng)*doorLen);ctx.stroke();const handleX=pivotX+Math.cos(currentAng)*doorLen*0.85;const handleY=pivotY+Math.sin(currentAng)*doorLen*0.85;ctx.fillStyle='#ffd700';ctx.beginPath();ctx.arc(handleX,handleY,4,0,Math.PI*2);ctx.fill();if(closeProgress===0){ctx.strokeStyle='rgba(76,175,80,0.3)';ctx.lineWidth=1;ctx.beginPath();ctx.arc(pivotX,pivotY,doorLen,Math.min(baseAng,openAng),Math.max(baseAng,openAng));ctx.stroke();}const queued=S.queuedDoorActions[e.id];if(queued&&queued.action==='close'){const midX=(e.x1+e.x2)/2;const midY=(e.y1+e.y2)/2;ctx.fillStyle='rgba(244,67,54,0.9)';ctx.beginPath();ctx.arc(midX,midY,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.font='bold 14px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚ñ∂',midX,midY);}}else if([E.OP,E.THREAT,E.CIV].includes(e.type)){drawChar(e,e.type===E.OP?'O':e.type===E.THREAT?'X':'C',e.type===E.OP?(e.color||'#4CAF50'):e.type===E.THREAT?'#e94560':'#4fc3f7',sel);}}

function drawChar(e,ltr,col,sel){const x=e.cx!==undefined?e.cx:e.x,y=e.cy!==undefined?e.cy:e.y,dir=e.cd!==undefined?e.cd:(e.direction||0);if(S.showFOV&&(e.type===E.OP||e.type===E.THREAT))drawFOV(x,y,dir,e.fovAngle||S.fovAngle,e.fovRange||S.fovRange,col);ctx.fillStyle='#2d2d2d';ctx.strokeStyle=sel?'#fff':col;ctx.lineWidth=2;ctx.beginPath();ctx.arc(x,y,12,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.fillStyle=col;ctx.beginPath();ctx.moveTo(x+Math.cos(dir)*15,y+Math.sin(dir)*15);ctx.lineTo(x+Math.cos(dir-2.5)*10,y+Math.sin(dir-2.5)*10);ctx.lineTo(x+Math.cos(dir+2.5)*10,y+Math.sin(dir+2.5)*10);ctx.closePath();ctx.fill();ctx.fillStyle=col;ctx.font='bold 12px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(ltr,x,y);if(e.label){ctx.fillStyle='#fff';ctx.font='bold 10px sans-serif';ctx.fillText(e.label,x,y+22);}ctx.textAlign='left';ctx.textBaseline='alphabetic';if(sel){ctx.strokeStyle='#4CAF50';ctx.lineWidth=2;ctx.setLineDash([4,4]);ctx.beginPath();ctx.arc(x,y,18,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);}}

function drawFOV(x,y,dir,angDeg,range,col){const half=(angDeg*Math.PI/180)/2,rays=Math.max(20,Math.floor(angDeg/2));ctx.save();const pts=[{x,y}];for(let i=0;i<=rays;i++){const ang=dir-half+(i/rays)*(half*2),d=castRay(x,y,ang,range);pts.push({x:x+Math.cos(ang)*d,y:y+Math.sin(ang)*d});}ctx.globalAlpha=0.15;ctx.fillStyle=col;ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i].x,pts[i].y);ctx.closePath();ctx.fill();ctx.globalAlpha=0.4;ctx.strokeStyle=col;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(pts[1].x,pts[1].y);ctx.stroke();ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);ctx.stroke();ctx.restore();}

const ctxMenu=document.getElementById('contextMenu');
const doorCtxMenu=document.getElementById('doorContextMenu');
const doorActionsDiv=document.getElementById('doorActions');
let nearbyDoor=null;

function getDoorMaxOpenAngle(door){const doorLen=Math.hypot(door.x2-door.x1,door.y2-door.y1);const doorAng=Math.atan2(door.y2-door.y1,door.x2-door.x1);const swing=door.swing||'in-left';const pivotX=swing.includes('left')?door.x1:door.x2;const pivotY=swing.includes('left')?door.y1:door.y2;const swingDir=swing.includes('in')?1:-1;const baseAng=swing.includes('left')?doorAng:doorAng+Math.PI;const maxAngle=175*Math.PI/180;const tolerance=S.gridSize/2;for(const e of S.entities){if(e.type===E.WALL){const wallAtPivot=(Math.hypot(e.x1-pivotX,e.y1-pivotY)<tolerance)||(Math.hypot(e.x2-pivotX,e.y2-pivotY)<tolerance);if(wallAtPivot){const wallAng=Math.atan2(e.y2-e.y1,e.x2-e.x1);const wallStart=(Math.hypot(e.x1-pivotX,e.y1-pivotY)<tolerance)?{x:e.x2,y:e.y2}:{x:e.x1,y:e.y1};const wallDir=Math.atan2(wallStart.y-pivotY,wallStart.x-pivotX);let angleDiff=wallDir-baseAng;while(angleDiff>Math.PI)angleDiff-=2*Math.PI;while(angleDiff<-Math.PI)angleDiff+=2*Math.PI;if(swingDir>0&&angleDiff>0&&angleDiff<maxAngle){return Math.max(0,angleDiff-10*Math.PI/180);}else if(swingDir<0&&angleDiff<0&&angleDiff>-maxAngle){return Math.max(0,Math.abs(angleDiff)-10*Math.PI/180);}}}}return maxAngle;}

function generateDoorOpenPath(door,operator,side){const doorMidX=(door.x1+door.x2)/2;const doorMidY=(door.y1+door.y2)/2;const doorAng=Math.atan2(door.y2-door.y1,door.x2-door.x1);const perpAng=doorAng+Math.PI/2;const doorLen=Math.hypot(door.x2-door.x1,door.y2-door.y1);const swing=door.swing||'in-left';const handleX=swing.includes('left')?door.x2:door.x1;const handleY=swing.includes('left')?door.y2:door.y1;const hingeX=swing.includes('left')?door.x1:door.x2;const hingeY=swing.includes('left')?door.y1:door.y2;const opX=operator.cx!==undefined?operator.cx:operator.x;const opY=operator.cy!==undefined?operator.cy:operator.y;const handleSideDir=Math.atan2(handleY-doorMidY,handleX-doorMidX);const opDir=Math.atan2(opY-doorMidY,opX-doorMidX);let handleDiff=opDir-handleSideDir;while(handleDiff>Math.PI)handleDiff-=2*Math.PI;while(handleDiff<-Math.PI)handleDiff+=2*Math.PI;const isOnHandleSide=Math.abs(handleDiff)<Math.PI/2;const standoff=isOnHandleSide?S.gridSize*0.8:S.gridSize*1.2;const fullApproachX=handleX+(side>0?Math.cos(perpAng)*standoff:-Math.cos(perpAng)*standoff);const fullApproachY=handleY+(side>0?Math.sin(perpAng)*standoff:-Math.sin(perpAng)*standoff);const distToApproach=Math.hypot(fullApproachX-opX,fullApproachY-opY);const reducedDist=Math.max(0,distToApproach-S.gridSize);const approachDir=Math.atan2(fullApproachY-opY,fullApproachX-opX);const approachX=opX+Math.cos(approachDir)*reducedDist;const approachY=opY+Math.sin(approachDir)*reducedDist;const path=[{x:opX,y:opY}];const steps=8;const holdFrames=isOnHandleSide?8:2;for(let i=1;i<=steps;i++){const t=i/steps;path.push({x:opX+(approachX-opX)*t,y:opY+(approachY-opY)*t});}for(let i=0;i<holdFrames;i++){path.push({x:approachX,y:approachY});}for(let i=steps;i>=0;i--){const t=i/steps;path.push({x:opX+(approachX-opX)*t,y:opY+(approachY-opY)*t});}const lookPoints=[];let traveled=0;for(let i=1;i<path.length;i++){const segLen=Math.hypot(path[i].x-path[i-1].x,path[i].y-path[i-1].y);traveled+=segLen;const ptX=(path[i-1].x+path[i].x)/2;const ptY=(path[i-1].y+path[i].y)/2;let lookDir;if(isOnHandleSide){lookDir=Math.atan2(doorMidY-ptY,doorMidX-ptX);}else{lookDir=Math.atan2(handleY-ptY,handleX-ptX);}lookPoints.push({distance:traveled-segLen/2,direction:lookDir});}const doorOpenFrame=isOnHandleSide?steps:steps+holdFrames;const doorDuration=isOnHandleSide?600:3750;return{path:path,lookPoints:lookPoints,doorOpenFrame:doorOpenFrame,doorDuration:doorDuration,isReachAcross:!isOnHandleSide};}

function applyDoorOpenPath(operator,door,side,withVTA){const openData=generateDoorOpenPath(door,operator,side);operator.doorOpenPath=openData.path;operator.doorOpenLookPoints=openData.lookPoints;operator.doorOpenFrame=openData.doorOpenFrame;operator.doorOpenPending=true;operator.doorOpenDoorId=door.id;operator.doorOpenWithVTA=withVTA;operator.doorDuration=openData.doorDuration||400;operator.isReachAcross=openData.isReachAcross||false;if(withVTA){const vtaData=generateVTAPath(door,operator,side);operator.vtaPathAfter=vtaData.path;operator.vtaLookPointsAfter=vtaData.lookPoints;}}

function showDoorContextMenu(x,y,door){doorCtxMenu.style.left=x+'px';doorCtxMenu.style.top=y+'px';doorCtxMenu.classList.add('active');S.contextMenuOpen=true;}

function findNearbyDoor(entity){const ex=entity.cx!==undefined?entity.cx:entity.x;const ey=entity.cy!==undefined?entity.cy:entity.y;const threshold=S.gridSize*2;let closest=null,closestDist=Infinity;for(const e of S.entities){if(e.type===E.DOOR_C||e.type===E.DOOR_O){const d=distSeg(ex,ey,e.x1,e.y1,e.x2,e.y2);if(d<threshold&&d<closestDist){closestDist=d;closest=e;}}}return closest;}

function getOperatorsNearDoor(door){const threshold=S.gridSize*2.5;const ops=[];const doorMidX=(door.x1+door.x2)/2;const doorMidY=(door.y1+door.y2)/2;const doorAng=Math.atan2(door.y2-door.y1,door.x2-door.x1);const perpAng=doorAng+Math.PI/2;for(const e of S.entities){if([E.OP,E.THREAT,E.CIV].includes(e.type)){const ex=e.cx!==undefined?e.cx:e.x;const ey=e.cy!==undefined?e.cy:e.y;const d=distSeg(ex,ey,door.x1,door.y1,door.x2,door.y2);if(d<threshold){const dx=ex-doorMidX;const dy=ey-doorMidY;const side=Math.sign(dx*Math.cos(perpAng)+dy*Math.sin(perpAng));ops.push({entity:e,side:side});}}}return ops;}

function isCenterFedDoor(door){const ops=getOperatorsNearDoor(door);const hasOpOnBothSides=ops.some(o=>o.side>0)&&ops.some(o=>o.side<0);if(!hasOpOnBothSides)return false;const doorLen=Math.hypot(door.x2-door.x1,door.y2-door.y1);const doorAng=Math.atan2(door.y2-door.y1,door.x2-door.x1);const minWallLen=S.gridSize*2;let wallOnSide1=false,wallOnSide2=false;for(const e of S.entities){if(e.type===E.WALL){const wallLen=Math.hypot(e.x2-e.x1,e.y2-e.y1);if(wallLen<minWallLen)continue;const tolerance=S.gridSize/2;if(Math.hypot(e.x1-door.x1,e.y1-door.y1)<tolerance||Math.hypot(e.x2-door.x1,e.y2-door.y1)<tolerance){wallOnSide1=true;}if(Math.hypot(e.x1-door.x2,e.y1-door.y2)<tolerance||Math.hypot(e.x2-door.x2,e.y2-door.y2)<tolerance){wallOnSide2=true;}}}return wallOnSide1&&wallOnSide2;}

function getDoorThresholdPosition(door,side){const doorMidX=(door.x1+door.x2)/2;const doorMidY=(door.y1+door.y2)/2;const doorAng=Math.atan2(door.y2-door.y1,door.x2-door.x1);const perpAng=doorAng+Math.PI/2;const standoffDist=S.gridSize*0.6;const swing=door.swing||'in-left';const hingeX=swing.includes('left')?door.x1:door.x2;const hingeY=swing.includes('left')?door.y1:door.y2;const handleX=swing.includes('left')?door.x2:door.x1;const handleY=swing.includes('left')?door.y2:door.y1;if(side>0){return{x:handleX+Math.cos(perpAng)*standoffDist,y:handleY+Math.sin(perpAng)*standoffDist};}else{return{x:handleX-Math.cos(perpAng)*standoffDist,y:handleY-Math.sin(perpAng)*standoffDist};}}

function generateVTAPath(door,operator,side){const doorMidX=(door.x1+door.x2)/2;const doorMidY=(door.y1+door.y2)/2;const doorAng=Math.atan2(door.y2-door.y1,door.x2-door.x1);const perpAng=doorAng+Math.PI/2;const doorLen=Math.hypot(door.x2-door.x1,door.y2-door.y1);const halfDoor=doorLen/2;const opX=operator.cx!==undefined?operator.cx:operator.x;const opY=operator.cy!==undefined?operator.cy:operator.y;const dist1=Math.hypot(opX-door.x1,opY-door.y1);const dist2=Math.hypot(opX-door.x2,opY-door.y2);const pivotX=dist1<dist2?door.x1:door.x2;const pivotY=dist1<dist2?door.y1:door.y2;const toDoorCenterX=doorMidX-opX;const toDoorCenterY=doorMidY-opY;const dotProduct=toDoorCenterX*Math.cos(doorAng)+toDoorCenterY*Math.sin(doorAng);const directionSign=dotProduct>0?1:-1;const peakX=opX+Math.cos(doorAng)*halfDoor*directionSign;const peakY=opY+Math.sin(doorAng)*halfDoor*directionSign;const path=[{x:opX,y:opY}];const steps=20;for(let i=1;i<=steps/2;i++){const t=i/(steps/2);const px=opX+(peakX-opX)*t;const py=opY+(peakY-opY)*t;path.push({x:px,y:py});}for(let i=steps/2-1;i>=0;i--){const t=i/(steps/2);const px=opX+(peakX-opX)*t;const py=opY+(peakY-opY)*t;path.push({x:px,y:py});}const lookPoints=[];let traveled=0;for(let i=1;i<path.length;i++){const segLen=Math.hypot(path[i].x-path[i-1].x,path[i].y-path[i-1].y);const midDist=traveled+segLen*0.5;const midX=(path[i-1].x+path[i].x)/2;const midY=(path[i-1].y+path[i].y)/2;const lookDir=Math.atan2(pivotY-midY,pivotX-midX);lookPoints.push({distance:midDist,direction:lookDir});traveled+=segLen;}return{path:path,lookPoints:lookPoints,isVTA:true};}

function applyVTAPath(operator,door,side){const vtaData=generateVTAPath(door,operator,side);operator.vtaPath=vtaData.path;operator.vtaLookPoints=vtaData.lookPoints;operator.vtaPending=true;operator.isVTAPath=true;}

function hideContextMenu(){ctxMenu.classList.remove('active');doorCtxMenu.classList.remove('active');S.contextMenuOpen=false;S.addingLookPoint=false;nearbyDoor=null;}

function showContextMenu(x,y){if(S.selected&&[E.OP,E.THREAT,E.CIV].includes(S.selected.item.type)){nearbyDoor=findNearbyDoor(S.selected.item);if(nearbyDoor){doorActionsDiv.style.display='block';document.getElementById('openDoor').style.display=nearbyDoor.type===E.DOOR_C?'block':'none';document.getElementById('openDoorVTA').style.display=nearbyDoor.type===E.DOOR_C?'block':'none';document.getElementById('vtaOnly').style.display=nearbyDoor.type===E.DOOR_O?'block':'none';document.getElementById('closeDoor').style.display=nearbyDoor.type===E.DOOR_O?'block':'none';}else{doorActionsDiv.style.display='none';}}else{doorActionsDiv.style.display='none';}ctxMenu.style.left=x+'px';ctxMenu.style.top=y+'px';ctxMenu.classList.add('active');S.contextMenuOpen=true;}

canvas.addEventListener('mousedown',e=>{const sp=mPos(e),wp=s2w(sp.x,sp.y),sn={x:snap(wp.x),y:snap(wp.y)};
if(S.tool==='select'||S.tool==='path'){for(const ent of S.entities){if([E.OP,E.THREAT,E.CIV].includes(ent.type)&&ent.path&&ent.path.length>1){const p=ent.path;let closestDist=Infinity,closestPt=null,closestPathDist=0,traveled=0;for(let i=1;i<p.length;i++){const seg={x1:p[i-1].x,y1:p[i-1].y,x2:p[i].x,y2:p[i].y};const segLen=Math.hypot(seg.x2-seg.x1,seg.y2-seg.y1);const t=Math.max(0,Math.min(1,((wp.x-seg.x1)*(seg.x2-seg.x1)+(wp.y-seg.y1)*(seg.y2-seg.y1))/(segLen*segLen||1)));const proj={x:seg.x1+t*(seg.x2-seg.x1),y:seg.y1+t*(seg.y2-seg.y1)};const d=Math.hypot(wp.x-proj.x,wp.y-proj.y);if(d<closestDist){closestDist=d;closestPt=proj;closestPathDist=traveled+t*segLen;}traveled+=segLen;}if(closestPt&&closestDist<15){S.draggingLookPoint={item:ent,pathPt:closestPt,pathDist:closestPathDist,currentDir:Math.atan2(wp.y-closestPt.y,wp.x-closestPt.x)};S.selected={type:'entity',item:ent,idx:S.entities.indexOf(ent)};draw();return;}}}}
hideContextMenu();
if(S.spaceHeld||S.tool==='pan'){S.panning=true;S.panStart={x:e.clientX-S.panX,y:e.clientY-S.panY};canvas.classList.add('cursor-grabbing');return;}
if(S.tool==='select'){const f=findAt(wp.x,wp.y);S.selected=f;if(f&&[E.OP,E.THREAT,E.CIV].includes(f.item.type)){const screenX=e.clientX,screenY=e.clientY;setTimeout(()=>showContextMenu(screenX,screenY),50);}else if(f&&[E.DOOR_C,E.DOOR_O].includes(f.item.type)){const screenX=e.clientX,screenY=e.clientY;setTimeout(()=>showDoorContextMenu(screenX,screenY,f.item),50);}if(f){const it=f.item;if(it.x!==undefined)S.dragOff={x:wp.x-it.x,y:wp.y-it.y};else if(it.x1!==undefined)S.dragOff={x:wp.x-it.x1,y:wp.y-it.y1,isLine:true,dx:it.x2-it.x1,dy:it.y2-it.y1};else if(it.points)S.dragOff={x:wp.x,y:wp.y,isPath:true};}}
else if(S.tool==='erase'){S.drawing=true;S.erasing=true;S.path=[wp];}
else if(S.tool==='pen'){S.drawing=true;S.path=[wp];}
else if(['wall','door-closed','door-open'].includes(S.tool)){S.drawing=true;S.drawStart=sn;S.path=[sn];}
else if(S.tool==='path'){const f=findAt(wp.x,wp.y);if(f&&f.type==='entity'&&[E.OP,E.THREAT,E.CIV].includes(f.item.type)){if(S.selected&&S.selected.item===f.item){S.drawing=true;S.pathBlocked=false;S.path=[wp];}else{S.selected=f;draw();}}else if(S.selected&&S.selected.type==='entity'&&[E.OP,E.THREAT,E.CIV].includes(S.selected.item.type)){S.drawing=true;S.pathBlocked=false;S.path=[wp];}}
else if(S.tool==='operator'){const n=S.entities.filter(x=>x.type===E.OP).length+1;S.entities.push({id:Date.now(),type:E.OP,x:sn.x,y:sn.y,color:S.opColor,label:String(n),path:[],lookPoints:[],direction:0,fovAngle:S.fovAngle,fovRange:S.fovRange});save();}
else if(S.tool==='threat'){S.entities.push({id:Date.now(),type:E.THREAT,x:sn.x,y:sn.y,path:[],lookPoints:[],direction:0,fovAngle:60,fovRange:100});save();}
else if(S.tool==='civilian'){S.entities.push({id:Date.now(),type:E.CIV,x:sn.x,y:sn.y,path:[],lookPoints:[],direction:0});save();}
draw();});

canvas.addEventListener('mousemove',e=>{const sp=mPos(e),wp=s2w(sp.x,sp.y),sn={x:snap(wp.x),y:snap(wp.y)};
if(S.draggingLookPoint){const pt=S.draggingLookPoint.pathPt;S.draggingLookPoint.currentDir=Math.atan2(wp.y-pt.y,wp.x-pt.x);draw();return;}
if(S.panning){S.panX=e.clientX-S.panStart.x;S.panY=e.clientY-S.panStart.y;draw();return;}
if(S.erasing){eraseAt(wp.x,wp.y);draw();return;}
if(S.drawing){if(S.tool==='pen')S.path.push(wp);else if(S.tool==='path'){const last=S.path.length?S.path[S.path.length-1]:{x:S.selected.item.x,y:S.selected.item.y};const hit=wallHitForPath(last.x,last.y,wp.x,wp.y);if(hit){S.path.push({x:last.x+(hit.x-last.x)*0.95,y:last.y+(hit.y-last.y)*0.95});S.pathBlocked=true;}else if(!S.pathBlocked)S.path.push(wp);}else if(['wall','door-closed','door-open'].includes(S.tool))S.path=[sn];draw();return;}
if(S.selected&&S.dragOff&&!S.playing){const it=S.selected.item;if(S.dragOff.isPath&&it.points){const dx=wp.x-S.dragOff.x,dy=wp.y-S.dragOff.y;it.points=it.points.map(p=>({x:p.x+dx,y:p.y+dy}));S.dragOff.x=wp.x;S.dragOff.y=wp.y;}else if(S.dragOff.isLine){it.x1=snap(wp.x-S.dragOff.x);it.y1=snap(wp.y-S.dragOff.y);it.x2=it.x1+S.dragOff.dx;it.y2=it.y1+S.dragOff.dy;}else if(it.x!==undefined){it.x=sn.x;it.y=sn.y;it.cx=sn.x;it.cy=sn.y;}draw();}});

canvas.addEventListener('mouseup',e=>{
if(S.draggingLookPoint){const lp=S.draggingLookPoint;if(!lp.item.lookPoints)lp.item.lookPoints=[];lp.item.lookPoints.push({distance:lp.pathDist,direction:lp.currentDir});lp.item.lookPoints.sort((a,b)=>a.distance-b.distance);save();S.draggingLookPoint=null;S.addingLookPoint=false;draw();return;}
if(S.panning){S.panning=false;canvas.classList.remove('cursor-grabbing');return;}
if(S.erasing){S.erasing=false;S.drawing=false;S.path=[];save();draw();return;}
if(S.drawing){const wp=s2w(...Object.values(mPos(e))),sn={x:snap(wp.x),y:snap(wp.y)};if(S.tool==='pen'&&S.path.length>1){S.drawings.push({id:Date.now(),type:'pen',points:[...S.path],color:S.drawColor,size:S.strokeSize});save();}else if(S.tool==='path'&&S.selected&&S.path.length>1){const raw=[{x:S.selected.item.x,y:S.selected.item.y},...S.path],simp=simplify(raw,5);S.selected.item.path=simp.length>=3?smooth(simp,3):simp;S.selected.item.lookPoints=[];S.selected.item.cx=S.selected.item.x;S.selected.item.cy=S.selected.item.y;S.selected.item.cd=S.selected.item.direction;save();}else if(['wall','door-closed','door-open'].includes(S.tool)&&S.drawStart&&S.path.length){const end=S.path[0];if(Math.hypot(end.x-S.drawStart.x,end.y-S.drawStart.y)>=10){if(S.tool==='wall'){for(let i=S.entities.length-1;i>=0;i--){const e=S.entities[i];if(e.type===E.DOOR_C||e.type===E.DOOR_O){const overlap=linesOverlap(S.drawStart.x,S.drawStart.y,end.x,end.y,e.x1,e.y1,e.x2,e.y2);if(overlap)S.entities.splice(i,1);}}}S.entities.push({id:Date.now(),type:S.tool,x1:S.drawStart.x,y1:S.drawStart.y,x2:end.x,y2:end.y,swing:'in-left'});save();}}S.drawing=false;S.drawStart=null;S.path=[];S.pathBlocked=false;}
if(S.selected&&S.dragOff){save();S.dragOff=null;}draw();});

canvas.addEventListener('wheel',e=>{e.preventDefault();const sp=mPos(e),wb=s2w(sp.x,sp.y);S.zoom=Math.max(0.2,Math.min(5,S.zoom*(e.deltaY>0?0.9:1.1)));const wa=s2w(sp.x,sp.y);S.panX+=(wa.x-wb.x)*S.zoom;S.panY+=(wa.y-wb.y)*S.zoom;draw();},{passive:false});

document.addEventListener('keydown',e=>{if(e.target.matches('input,textarea'))return;if(e.code==='Space'&&!S.spaceHeld){S.spaceHeld=true;canvas.classList.add('cursor-grab');}if((e.key==='Delete'||e.key==='Backspace')&&S.selected){if(S.selected.type==='drawing')S.drawings.splice(S.selected.idx,1);else S.entities.splice(S.selected.idx,1);S.selected=null;save();draw();}if(e.key==='Escape'){S.selected=null;S.drawing=false;S.path=[];draw();}if((e.key==='r'||e.key==='R')&&S.selected&&S.selected.item.direction!==undefined){S.selected.item.direction+=e.shiftKey?-Math.PI/8:Math.PI/8;save();draw();}if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();undo();}if((e.ctrlKey||e.metaKey)&&e.key==='y'){e.preventDefault();redo();}});
document.addEventListener('keyup',e=>{if(e.code==='Space'){S.spaceHeld=false;canvas.classList.remove('cursor-grab');}});

document.querySelectorAll('.tool-btn[data-tool]').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.tool-btn[data-tool]').forEach(x=>x.classList.remove('active'));b.classList.add('active');S.tool=b.dataset.tool;draw();}));
document.getElementById('clearPathBtn').addEventListener('click',()=>{if(S.selected&&S.selected.item.path){S.selected.item.path=[];S.selected.item.lookPoints=[];S.selected.item.cx=S.selected.item.x;S.selected.item.cy=S.selected.item.y;S.selected.item.cd=S.selected.item.direction;save();draw();}});
document.getElementById('drawColors').addEventListener('click',e=>{if(e.target.classList.contains('color-swatch')){document.querySelectorAll('#drawColors .color-swatch').forEach(x=>x.classList.remove('active'));e.target.classList.add('active');S.drawColor=e.target.dataset.color;}});
document.getElementById('operatorColors').addEventListener('click',e=>{if(e.target.classList.contains('color-swatch')){document.querySelectorAll('#operatorColors .color-swatch').forEach(x=>x.classList.remove('active'));e.target.classList.add('active');S.opColor=e.target.dataset.color;}});
document.getElementById('fovAngle').addEventListener('input',e=>{S.fovAngle=parseInt(e.target.value);document.getElementById('fovAngleVal').textContent=S.fovAngle;if(S.selected&&S.selected.item&&(S.selected.item.type===E.OP||S.selected.item.type===E.THREAT)){S.selected.item.fovAngle=S.fovAngle;draw();}});
document.getElementById('playBtn').addEventListener('click',()=>{if(S.playing)stopPlay(false);else startPlay();});
document.getElementById('rewindBtn').addEventListener('click',rewind);
document.getElementById('speedSelect').addEventListener('change',e=>{S.playSpeed=parseFloat(e.target.value);});
document.getElementById('newBtn').addEventListener('click',()=>{stopPlay(false);S.entities=[];S.drawings=[];S.selected=null;S.zoom=1;S.panX=0;S.panY=0;S.history=[];S.historyIdx=-1;save();draw();});
document.getElementById('undoBtn').addEventListener('click',undo);
document.getElementById('redoBtn').addEventListener('click',redo);
document.getElementById('gridToggle').addEventListener('click',e=>{S.showGrid=!S.showGrid;e.target.classList.toggle('active',S.showGrid);draw();});
document.getElementById('fovToggle').addEventListener('click',e=>{S.showFOV=!S.showFOV;e.target.classList.toggle('active',S.showFOV);draw();});
const modal=document.getElementById('modal');
document.getElementById('saveBtn').addEventListener('click',()=>{document.getElementById('modalTitle').textContent='Save';document.getElementById('modalData').value=JSON.stringify({entities:S.entities.map(e=>({...e,cx:undefined,cy:undefined,cd:undefined})),drawings:S.drawings},null,2);document.getElementById('modalConfirm').textContent='Copy';modal.classList.add('active');});
document.getElementById('loadBtn').addEventListener('click',()=>{document.getElementById('modalTitle').textContent='Load';document.getElementById('modalData').value='';document.getElementById('modalConfirm').textContent='Load';modal.classList.add('active');});
document.getElementById('scenarioSelect').addEventListener('change',e=>{const k=e.target.value;if(!k)return;const sc=SCENARIOS[k];if(sc){stopPlay(false);S.entities=JSON.parse(JSON.stringify(sc.entities));S.drawings=JSON.parse(JSON.stringify(sc.drawings));S.selected=null;S.zoom=1;S.panX=0;S.panY=0;S.history=[];S.historyIdx=-1;save();draw();}e.target.value='';});
document.getElementById('modalCancel').addEventListener('click',()=>modal.classList.remove('active'));
document.getElementById('modalConfirm').addEventListener('click',()=>{const t=document.getElementById('modalTitle').textContent,d=document.getElementById('modalData').value;if(t.includes('Save')){navigator.clipboard.writeText(d);alert('Copied!');}else{try{const p=JSON.parse(d);S.entities=p.entities||[];S.drawings=p.drawings||[];S.selected=null;save();draw();}catch{alert('Invalid JSON');return;}}modal.classList.remove('active');});
document.getElementById('sidebarToggle').addEventListener('click',()=>document.querySelector('.sidebar').classList.toggle('open'));
canvas.addEventListener('click',()=>{if(window.innerWidth<=768)document.querySelector('.sidebar').classList.remove('open');});

document.getElementById('rotateLeft').addEventListener('click',()=>{if(S.selected&&S.selected.item.direction!==undefined){S.selected.item.direction-=Math.PI/8;save();draw();}});
document.getElementById('rotateRight').addEventListener('click',()=>{if(S.selected&&S.selected.item.direction!==undefined){S.selected.item.direction+=Math.PI/8;save();draw();}});
document.getElementById('addLookPoint').addEventListener('click',()=>{if(S.selected&&S.selected.item.path&&S.selected.item.path.length>1){S.addingLookPoint=true;hideContextMenu();canvas.style.cursor='crosshair';}else{alert('Draw a path first, then add look points.');}});
document.getElementById('clearPath').addEventListener('click',()=>{if(S.selected&&S.selected.item){S.selected.item.path=[];S.selected.item.lookPoints=[];S.selected.item.cx=S.selected.item.x;S.selected.item.cy=S.selected.item.y;S.selected.item.cd=S.selected.item.direction;save();draw();hideContextMenu();}});
document.getElementById('openDoor').addEventListener('click',()=>{if(nearbyDoor&&nearbyDoor.type===E.DOOR_C&&S.selected){const ops=getOperatorsNearDoor(nearbyDoor);const opData=ops.find(o=>o.entity.id===S.selected.item.id);if(opData){applyDoorOpenPath(S.selected.item,nearbyDoor,opData.side,false);}S.queuedDoorActions[nearbyDoor.id]={action:'open',operatorId:S.selected.item.id};draw();hideContextMenu();}});
document.getElementById('vtaOnly').addEventListener('click',()=>{if(nearbyDoor&&nearbyDoor.type===E.DOOR_O&&S.selected){const ops=getOperatorsNearDoor(nearbyDoor);const opData=ops.find(o=>o.entity.id===S.selected.item.id);if(opData){applyVTAPath(S.selected.item,nearbyDoor,opData.side);const centerFed=isCenterFedDoor(nearbyDoor);if(centerFed){for(const od of ops){if(od.entity.id!==S.selected.item.id){applyVTAPath(od.entity,nearbyDoor,od.side);}}}}draw();hideContextMenu();}});
document.getElementById('openDoorVTA').addEventListener('click',()=>{if(nearbyDoor&&nearbyDoor.type===E.DOOR_C&&S.selected){const ops=getOperatorsNearDoor(nearbyDoor);const opData=ops.find(o=>o.entity.id===S.selected.item.id);if(opData){applyDoorOpenPath(S.selected.item,nearbyDoor,opData.side,true);const centerFed=isCenterFedDoor(nearbyDoor);if(centerFed){for(const od of ops){if(od.entity.id!==S.selected.item.id){applyDoorOpenPath(od.entity,nearbyDoor,od.side,true);}}}}S.queuedDoorActions[nearbyDoor.id]={action:'open-vta',operatorId:S.selected.item.id};draw();hideContextMenu();}});
document.getElementById('closeDoor').addEventListener('click',()=>{if(nearbyDoor&&nearbyDoor.type===E.DOOR_O&&S.selected){S.queuedDoorActions[nearbyDoor.id]={action:'close',operatorId:S.selected.item.id};draw();hideContextMenu();}});
document.getElementById('deleteEntity').addEventListener('click',()=>{if(S.selected){if(S.selected.type==='drawing')S.drawings.splice(S.selected.idx,1);else S.entities.splice(S.selected.idx,1);S.selected=null;save();draw();hideContextMenu();}});

document.getElementById('swingInLeft').addEventListener('click',()=>{if(S.selected&&[E.DOOR_C,E.DOOR_O].includes(S.selected.item.type)){S.selected.item.swing='in-left';save();draw();hideContextMenu();}});
document.getElementById('swingInRight').addEventListener('click',()=>{if(S.selected&&[E.DOOR_C,E.DOOR_O].includes(S.selected.item.type)){S.selected.item.swing='in-right';save();draw();hideContextMenu();}});
document.getElementById('swingOutLeft').addEventListener('click',()=>{if(S.selected&&[E.DOOR_C,E.DOOR_O].includes(S.selected.item.type)){S.selected.item.swing='out-left';save();draw();hideContextMenu();}});
document.getElementById('swingOutRight').addEventListener('click',()=>{if(S.selected&&[E.DOOR_C,E.DOOR_O].includes(S.selected.item.type)){S.selected.item.swing='out-right';save();draw();hideContextMenu();}});
document.getElementById('toggleDoorState').addEventListener('click',()=>{if(S.selected&&[E.DOOR_C,E.DOOR_O].includes(S.selected.item.type)){S.selected.item.type=S.selected.item.type===E.DOOR_C?E.DOOR_O:E.DOOR_C;save();draw();hideContextMenu();}});
document.getElementById('deleteDoor').addEventListener('click',()=>{if(S.selected&&[E.DOOR_C,E.DOOR_O].includes(S.selected.item.type)){S.entities.splice(S.selected.idx,1);S.selected=null;save();draw();hideContextMenu();}});

document.addEventListener('click',e=>{if(S.contextMenuOpen&&!ctxMenu.contains(e.target)&&!doorCtxMenu.contains(e.target)&&e.target!==canvas){hideContextMenu();}});

// Submit functionality
const submitModal=document.getElementById('submitModal');
const configModal=document.getElementById('configModal');
const SCRIPT_URL_KEY='waldo_script_url';
const DEFAULT_SCRIPT_URL='https://script.google.com/macros/s/AKfycbzjNirThr6zN7QFvunxhkAfWRNC9E3mxEBA4KNcKy-zBCPRLBmT1ASx_MxYIclHcEyGkA/exec';

let mediaRecorder=null;
let recordedChunks=[];
let recordedBlob=null;

function startRecording(){
  recordedChunks=[];
  const stream=canvas.captureStream(30);
  mediaRecorder=new MediaRecorder(stream,{mimeType:'video/webm'});
  mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedChunks.push(e.data);};
  mediaRecorder.onstop=()=>{recordedBlob=new Blob(recordedChunks,{type:'video/webm'});};
  mediaRecorder.start();
}

function stopRecording(){
  return new Promise(resolve=>{
    if(mediaRecorder&&mediaRecorder.state!=='inactive'){
      mediaRecorder.onstop=()=>{
        recordedBlob=new Blob(recordedChunks,{type:'video/webm'});
        resolve(recordedBlob);
      };
      mediaRecorder.stop();
    }else{
      resolve(null);
    }
  });
}

document.getElementById('submitBtn').addEventListener('click',()=>{
  submitModal.classList.add('active');
  document.getElementById('submitStatus').textContent='Draw your solution, then click "Record & Submit"';
  document.getElementById('submitConfirm').textContent='Record & Submit';
  recordedBlob=null;
});

document.getElementById('submitBtn').addEventListener('click',e=>{
  if(e.shiftKey){
    e.stopImmediatePropagation();
    document.getElementById('scriptUrl').value=localStorage.getItem(SCRIPT_URL_KEY)||DEFAULT_SCRIPT_URL;
    configModal.classList.add('active');
  }
},true);

document.getElementById('submitCancel').addEventListener('click',()=>submitModal.classList.remove('active'));
document.getElementById('configCancel').addEventListener('click',()=>configModal.classList.remove('active'));

document.getElementById('configSave').addEventListener('click',()=>{
  const url=document.getElementById('scriptUrl').value.trim();
  if(url){
    localStorage.setItem(SCRIPT_URL_KEY,url);
    alert('Script URL saved!');
  }else{
    localStorage.removeItem(SCRIPT_URL_KEY);
  }
  configModal.classList.remove('active');
});

document.getElementById('submitConfirm').addEventListener('click',async()=>{
  const name=document.getElementById('submitterName').value.trim();
  const scenario=document.getElementById('scenarioName').value.trim();
  const status=document.getElementById('submitStatus');
  const btn=document.getElementById('submitConfirm');
  
  if(!name){status.textContent='Please enter your name';status.style.color='#f44';return;}
  if(!scenario){status.textContent='Please enter a scenario name';status.style.color='#f44';return;}
  
  // Check if there are paths to animate
  const hasPaths=S.entities.some(e=>e.path&&e.path.length>1)||S.entities.some(e=>e.vtaPending||e.doorOpenPending);
  if(!hasPaths){status.textContent='Draw paths for operators first';status.style.color='#f44';return;}
  
  btn.disabled=true;
  status.textContent='Recording playback...';status.style.color='#888';
  
  // Reset and start recording
  rewind();
  await new Promise(r=>setTimeout(r,100));
  startRecording();
  
  // Start playback and wait for it to finish
  const originalStopPlay=stopPlay;
  let playbackDone=false;
  stopPlay=function(done){
    originalStopPlay(done);
    if(done)playbackDone=true;
  };
  
  startPlay();
  
  // Wait for playback to complete (max 60 seconds)
  let waited=0;
  while(!playbackDone&&waited<60000){
    await new Promise(r=>setTimeout(r,100));
    waited+=100;
  }
  
  stopPlay=originalStopPlay;
  
  // Stop recording
  status.textContent='Processing video...';
  const videoBlob=await stopRecording();
  
  if(!videoBlob){
    status.textContent='Recording failed';status.style.color='#f44';
    btn.disabled=false;
    return;
  }
  
  // Convert to base64
  status.textContent='Uploading...';
  const reader=new FileReader();
  reader.onload=async()=>{
    const base64=reader.result.split(',')[1];
    const url=localStorage.getItem(SCRIPT_URL_KEY)||DEFAULT_SCRIPT_URL;
    
    const submission={
      name:name,
      scenarioName:scenario,
      timestamp:new Date().toISOString(),
      video:base64,
      entities:S.entities,
      drawings:S.drawings
    };
    
    try{
      await fetch(url,{
        method:'POST',
        mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(submission)
      });
      status.textContent='‚úì Submitted successfully!';
      status.style.color='#4CAF50';
      btn.disabled=false;
      setTimeout(()=>submitModal.classList.remove('active'),1500);
    }catch(err){
      status.textContent='Error: '+err.message;
      status.style.color='#f44';
      btn.disabled=false;
    }
  };
  reader.readAsDataURL(videoBlob);
});

let touchStartDist=0;let touchStartZoom=1;let touchStartPan={x:0,y:0};let touchMidStart={x:0,y:0};let isTwoFingerGesture=false;
canvas.addEventListener('touchstart',e=>{e.preventDefault();hideContextMenu();if(e.touches.length===2){isTwoFingerGesture=true;const t1=e.touches[0],t2=e.touches[1];touchStartDist=Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY);touchStartZoom=S.zoom;touchStartPan={x:S.panX,y:S.panY};touchMidStart={x:(t1.clientX+t2.clientX)/2,y:(t1.clientY+t2.clientY)/2};return;}isTwoFingerGesture=false;const t=e.touches[0],r=canvas.getBoundingClientRect(),sp={x:t.clientX-r.left,y:t.clientY-r.top},wp=s2w(sp.x,sp.y),sn={x:snap(wp.x),y:snap(wp.y)};if(S.tool==='pan'){S.panning=true;S.panStart={x:t.clientX-S.panX,y:t.clientY-S.panY};return;}if(S.tool==='select'){S.selected=findAt(wp.x,wp.y);if(S.selected){const it=S.selected.item;if(it.x!==undefined)S.dragOff={x:wp.x-it.x,y:wp.y-it.y};if([E.OP,E.THREAT,E.CIV].includes(it.type)){showContextMenu(t.clientX,t.clientY);}}}else if(S.tool==='erase'){S.drawing=true;S.erasing=true;S.path=[wp];}else if(S.tool==='pen'){S.drawing=true;S.path=[wp];}else if(['wall','door-closed','door-open'].includes(S.tool)){S.drawing=true;S.drawStart=sn;S.path=[sn];}else if(S.tool==='path'&&S.selected&&[E.OP,E.THREAT,E.CIV].includes(S.selected.item.type)){S.drawing=true;S.pathBlocked=false;S.path=[wp];}else if(S.tool==='operator'){const n=S.entities.filter(x=>x.type===E.OP).length+1;S.entities.push({id:Date.now(),type:E.OP,x:sn.x,y:sn.y,color:S.opColor,label:String(n),path:[],lookPoints:[],direction:0,fovAngle:S.fovAngle,fovRange:S.fovRange});save();}else if(S.tool==='threat'){S.entities.push({id:Date.now(),type:E.THREAT,x:sn.x,y:sn.y,path:[],lookPoints:[],direction:0,fovAngle:60,fovRange:100});save();}else if(S.tool==='civilian'){S.entities.push({id:Date.now(),type:E.CIV,x:sn.x,y:sn.y,path:[],lookPoints:[],direction:0});save();}draw();},{passive:false});
canvas.addEventListener('touchmove',e=>{e.preventDefault();if(e.touches.length===2&&isTwoFingerGesture){const t1=e.touches[0],t2=e.touches[1];const currentDist=Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY);const touchMid={x:(t1.clientX+t2.clientX)/2,y:(t1.clientY+t2.clientY)/2};const scale=currentDist/touchStartDist;const newZoom=Math.max(0.2,Math.min(5,touchStartZoom*scale));const panDeltaX=touchMid.x-touchMidStart.x;const panDeltaY=touchMid.y-touchMidStart.y;S.zoom=newZoom;S.panX=touchStartPan.x+panDeltaX;S.panY=touchStartPan.y+panDeltaY;draw();return;}if(e.touches.length!==1)return;const t=e.touches[0],r=canvas.getBoundingClientRect(),sp={x:t.clientX-r.left,y:t.clientY-r.top},wp=s2w(sp.x,sp.y),sn={x:snap(wp.x),y:snap(wp.y)};if(S.panning){S.panX=t.clientX-S.panStart.x;S.panY=t.clientY-S.panStart.y;draw();return;}if(S.erasing){eraseAt(wp.x,wp.y);draw();return;}if(S.drawing){if(S.tool==='pen')S.path.push(wp);else if(S.tool==='path'&&!S.pathBlocked){const last=S.path[S.path.length-1]||S.selected.item;const hit=wallHitForPath(last.x,last.y,wp.x,wp.y);if(hit){S.path.push({x:last.x+(hit.x-last.x)*0.95,y:last.y+(hit.y-last.y)*0.95});S.pathBlocked=true;}else S.path.push(wp);}else if(['wall','door-closed','door-open'].includes(S.tool))S.path=[sn];draw();}if(S.selected&&S.dragOff&&!S.playing){const it=S.selected.item;if(it.x!==undefined){it.x=sn.x;it.y=sn.y;it.cx=sn.x;it.cy=sn.y;}draw();}},{passive:false});
canvas.addEventListener('touchend',e=>{e.preventDefault();if(e.touches.length===0){isTwoFingerGesture=false;}if(e.touches.length>0)return;if(S.panning){S.panning=false;return;}if(S.erasing){S.erasing=false;S.drawing=false;S.path=[];save();draw();return;}if(S.drawing){if(S.tool==='pen'&&S.path.length>1){S.drawings.push({id:Date.now(),type:'pen',points:[...S.path],color:S.drawColor,size:S.strokeSize});save();}else if(S.tool==='path'&&S.selected&&S.path.length>1){const raw=[{x:S.selected.item.x,y:S.selected.item.y},...S.path],simp=simplify(raw,5);S.selected.item.path=simp.length>=3?smooth(simp,3):simp;S.selected.item.lookPoints=[];save();}else if(['wall','door-closed','door-open'].includes(S.tool)&&S.drawStart&&S.path.length){const end=S.path[0];if(Math.hypot(end.x-S.drawStart.x,end.y-S.drawStart.y)>=10){if(S.tool==='wall'){for(let i=S.entities.length-1;i>=0;i--){const ent=S.entities[i];if(ent.type===E.DOOR_C||ent.type===E.DOOR_O){const overlap=linesOverlap(S.drawStart.x,S.drawStart.y,end.x,end.y,ent.x1,ent.y1,ent.x2,ent.y2);if(overlap)S.entities.splice(i,1);}}}S.entities.push({id:Date.now(),type:S.tool,x1:S.drawStart.x,y1:S.drawStart.y,x2:end.x,y2:end.y,swing:'in-left'});save();}}S.drawing=false;S.drawStart=null;S.path=[];S.pathBlocked=false;}if(S.selected&&S.dragOff){save();S.dragOff=null;}draw();},{passive:false});

save();draw();
</script>
</body>
</html>
